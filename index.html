<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG SCENARIO GUIDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-style {
            font-family: 'Lora', serif;
        }
        .gm-mode .editable, .gm-mode .editable-in-place {
            display: none;
        }
        .writer-mode .viewable {
            display: none;
        }
        .sidebar-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }
        /* Simple toggle switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4299e1;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .story-arc-card {
            background-color: #1a202c; /* A darker background for arcs */
            border-left: 4px solid #4299e1; /* Blue accent line */
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .editable-tag {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .editable-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .editable-title {
             cursor: pointer;
             border-bottom: 2px dashed transparent;
        }
        .editable-title:hover {
             border-bottom: 2px dashed #9ca3af;
        }
        #projectHeader {
            position: relative;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: white !important;
                color: black !important;
            }
            #app {
                display: block !important; /* Override grid for printing */
            }
            aside, #projectTypeModal, #campaignSetupModal, #scenarioSetupModal, #mobileMessage, .editable, .no-print, .editable-in-place {
                display: none !important;
            }
            main {
                overflow-y: visible !important;
                height: auto !important;
            }
            .viewable {
                display: block !important; /* Ensure viewable content is visible */
            }
            .bg-white, .dark\:bg-gray-800, .story-arc-card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                background-color: white !important;
                color: black !important;
            }
            h2, h3, h4, p, span, div {
                color: black !important;
            }
            .prose-style {
                color: black !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 transition-colors duration-300 writer-mode">

    <!-- Initial Project Type Selection Modal -->
    <div id="projectTypeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-all scale-100 opacity-100">
            <h2 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-white">What are you creating?</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Choose a project type to get started.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="showCampaignSetup()" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-purple-500 hover:bg-purple-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Campaign</h3>
                    <p class="text-gray-600 dark:text-gray-400">A multi-session, long-form adventure with story arcs, factions, and deep world-building.</p>
                </button>
                <button onclick="showScenarioSetup()" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-teal-500 hover:bg-teal-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Scenario / One-Shot</h3>
                    <p class="text-gray-600 dark:text-gray-400">A self-contained adventure, ideal for a single session or a short series of games.</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Campaign Setup Modal -->
    <div id="campaignSetupModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-all">
            <h2 class="text-3xl font-bold mb-2 text-center text-gray-800 dark:text-white">Create Your New Campaign</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Define the core identity of your world and story.</p>
            <div class="space-y-4">
                <div>
                    <label for="campaignTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Campaign Title</label>
                    <input type="text" id="campaignTitle" placeholder="The Dragon's Inheritance" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="campaignPitch" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Campaign Pitch</label>
                    <textarea id="campaignPitch" rows="3" placeholder="A one-paragraph elevator pitch for your campaign." class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 prose-style"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="campaignGenre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Genre</label>
                        <select id="campaignGenre" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Heroic Fantasy</option><option>Investigative Horror</option><option>Dystopian Intrigue</option><option>Sci-Fi Opera</option><option>Political Thriller</option><option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="campaignTone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tone</label>
                        <select id="campaignTone" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Lighthearted</option><option>Gritty</option><option>Epic</option><option>Bleak</option><option>Mysterious</option><option>Other</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="campaignStructure" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Primary Structure</label>
                        <select id="campaignStructure" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Linear</option><option>Episodic</option><option>Sandbox</option><option>Hybrid</option>
                        </select>
                    </div>
                    <div>
                        <label for="campaignScope" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Scope</label>
                        <select id="campaignScope" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>One-Shot (1-2 Sessions)</option><option>Mini-Campaign (3-10 Sessions)</option><option>Long Campaign (10-50 Sessions)</option><option>Epic Campaign (50+ Sessions)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button onclick="startCampaign()" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all text-lg">Start Building</button>
            </div>
        </div>
    </div>

    <!-- Scenario Setup Modal -->
    <div id="scenarioSetupModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-all">
             <h2 class="text-3xl font-bold mb-2 text-center text-gray-800 dark:text-white">Create Your New Scenario</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Define the core identity of your one-shot or short adventure.</p>
            <div class="space-y-4">
                 <div>
                    <label for="scenarioTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Scenario Title</label>
                    <input type="text" id="scenarioTitle" placeholder="The Haunted Hills of Silverwood" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="scenarioSynopsis" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Synopsis / Overview</label>
                    <textarea id="scenarioSynopsis" rows="3" placeholder="A brief summary of the adventure's plot, goals, and themes." class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 prose-style"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="scenarioGenre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Genre</label>
                        <select id="scenarioGenre" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Dungeon Crawl</option><option>Mystery</option><option>Intrigue</option><option>Wilderness Survival</option><option>Horror</option><option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="scenarioStructure" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Primary Structure</label>
                        <select id="scenarioStructure" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Linear</option><option>Sandbox</option><option>Point Crawl (Hybrid)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button onclick="startScenario()" class="w-full md:w-auto px-8 py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all text-lg">Start Building</button>
            </div>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app" class="hidden md:grid md:grid-cols-[280px_1fr] h-screen">
        <!-- Sidebar -->
        <aside class="bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col p-4">
            <!-- Title Row -->
            <div class="mb-4 text-center">
                <h1 class="text-2xl font-bold">RPG SCENARIO GUIDE</h1>
            </div>

            <!-- Buttons Row -->
            <div class="flex justify-between items-center mb-8 px-2">
                <!-- File Menu Dropdown -->
                <div class="relative no-print">
                    <button id="fileMenuButton" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                        </svg>
                    </button>
                    <div id="fileMenu" class="hidden absolute left-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-gray-200 dark:border-gray-700">
                        <a href="#" id="printPdfButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Print to PDF</a>
                        <a href="#" id="saveLocalButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Save Local (.json)</a>
                        <a href="#" id="loadLocalButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Load Local (.json)</a>
                    </div>
                </div>
                
                <!-- Add New Project Button -->
                <button id="createNewProjectButton" title="Create New Project" class="p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 no-print">
                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 9a.75.75 0 00-1.5 0v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <nav class="flex-grow space-y-2 no-print">
                <h3 class="px-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Add Components</h3>
                 <button onclick="addComponent('story_arc')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 6H3"/><path d="M21 12H3"/><path d="M21 18H3"/></svg>
                    <span>Story Arc</span>
                </button>
                 <button onclick="addComponent('adventure')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m13.29 13.29-4.6 4.6a2 2 0 1 0 2.83 2.83l4.6-4.6a2 2 0 0 0 0-2.83l-4.6-4.6a2 2 0 1 0-2.83 2.83z"/><path d="M10.59 10.59 7.76 7.76"/><path d="m16.24 7.76-2.83 2.83"/></svg>
                    <span>Adventure/Quest</span>
                </button>
                <button onclick="addComponent('npc')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="4"/><path d="M18 11a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z"/></svg>
                    <span>NPC</span>
                </button>
                <button onclick="addComponent('location')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span>Location</span>
                </button>
                 <button onclick="addComponent('faction')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span>Faction</span>
                </button>
                <button onclick="addComponent('encounter')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m13.29 13.29-4.6 4.6a2 2 0 1 0 2.83 2.83l4.6-4.6a2 2 0 0 0 0-2.83l-4.6-4.6a2 2 0 1 0-2.83 2.83z"/><path d="M10.59 10.59 7.76 7.76"/><path d="m16.24 7.76-2.83 2.83"/></svg>
                    <span>Encounter</span>
                </button>
                <button onclick="addComponent('item')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 13V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h4"/><path d="M14 22h6a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Z"/></svg>
                    <span>Magic Item</span>
                </button>
                <button onclick="addComponent('clue')" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                     <svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><circle cx="11.5" cy="14.5" r="2.5"/><path d="M13.25 16.25 15 18"/></svg>
                    <span>Clue</span>
                </button>
            </nav>

            <div id="sidebarExtras" class="no-print mt-4"></div>

            <div class="mt-auto no-print">
                <div class="flex items-center justify-between p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                    <span class="font-semibold text-sm">Writer Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="modeToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="font-semibold text-sm">GM Mode</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="bg-gray-100 dark:bg-gray-900 overflow-y-auto">
            <div class="p-8">
                <div id="projectHeader" class="mb-8"></div>
                <div id="mainContent" class="space-y-6">
                    <!-- Components will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="loadFileInput" class="hidden" accept=".json">
    <input type="file" id="linkCampaignFileInput" class="hidden" accept=".json">

    <!-- Mobile view message -->
    <div id="mobileMessage" class="md:hidden flex flex-col items-center justify-center h-screen text-center p-4">
        <svg class="w-16 h-16 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-1.2 0-2.4.6-3 1.7A3.5 3.5 0 0 0 6.5 8c0 2.3 2.5 4.5 6 6.5 3.5-2 6-4.2 6-6.5a3.5 3.5 0 0 0-2.5-3.3c-.6-1.1-1.8-1.7-3-1.7Z"/><path d="m12 14-4 4h8l-4-4Z"/></svg>
        <h2 class="text-2xl font-bold mb-2">RPG SCENARIO GUIDE</h2>
        <p>This application is best experienced on a desktop or tablet device for the full creation workflow.</p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let project = {};
            let nextId = 1;

            const projectOptions = {
                campaignGenre: ['Heroic Fantasy', 'Investigative Horror', 'Dystopian Intrigue', 'Sci-Fi Opera', 'Political Thriller', 'Other'],
                campaignTone: ['Lighthearted', 'Gritty', 'Epic', 'Bleak', 'Mysterious', 'Other'],
                campaignStructure: ['Linear', 'Episodic', 'Sandbox', 'Hybrid'],
                campaignScope: ['One-Shot (1-2 Sessions)', 'Mini-Campaign (3-10 Sessions)', 'Long Campaign (10-50 Sessions)', 'Epic Campaign (50+ Sessions)'],
                scenarioGenre: ['Dungeon Crawl', 'Mystery', 'Intrigue', 'Wilderness Survival', 'Horror', 'Other'],
                scenarioStructure: ['Linear', 'Sandbox', 'Point Crawl (Hybrid)']
            };

            // --- DOM ELEMENTS ---
            const projectTypeModal = document.getElementById('projectTypeModal');
            const campaignSetupModal = document.getElementById('campaignSetupModal');
            const scenarioSetupModal = document.getElementById('scenarioSetupModal');
            const mainApp = document.getElementById('app');
            const mainContent = document.getElementById('mainContent');
            const projectHeader = document.getElementById('projectHeader');
            const modeToggle = document.getElementById('modeToggle');
            const body = document.body;
            const fileMenuButton = document.getElementById('fileMenuButton');
            const fileMenu = document.getElementById('fileMenu');
            const printPdfButton = document.getElementById('printPdfButton');
            const saveLocalButton = document.getElementById('saveLocalButton');
            const loadLocalButton = document.getElementById('loadLocalButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const createNewProjectButton = document.getElementById('createNewProjectButton');
            const linkCampaignFileInput = document.getElementById('linkCampaignFileInput');
            const sidebarExtras = document.getElementById('sidebarExtras');


            // --- FUNCTIONS ---

            const resetProject = () => {
                project = {
                    type: null, title: 'Untitled Project', pitch: '', synopsis: '',
                    genre: '', tone: '', scope: '', structure: '', components: [],
                    linkedCampaign: null
                };
                nextId = 1;
                document.getElementById('scenarioTitle').value = '';
                document.getElementById('scenarioSynopsis').value = '';
            };

            window.showCampaignSetup = () => {
                projectTypeModal.classList.add('hidden');
                projectTypeModal.classList.remove('flex');
                campaignSetupModal.classList.remove('hidden');
                campaignSetupModal.classList.add('flex');
            };

            window.showScenarioSetup = () => {
                projectTypeModal.classList.add('hidden');
                projectTypeModal.classList.remove('flex');
                scenarioSetupModal.classList.remove('hidden');
                scenarioSetupModal.classList.add('flex');
            };

            const hideAllModals = () => {
                projectTypeModal.classList.add('hidden');
                projectTypeModal.classList.remove('flex');
                campaignSetupModal.classList.add('hidden');
                campaignSetupModal.classList.remove('flex');
                scenarioSetupModal.classList.add('hidden');
                scenarioSetupModal.classList.remove('flex');
                mainApp.classList.remove('hidden');
            };

            window.startCampaign = () => {
                resetProject();
                project.type = 'campaign';
                project.title = document.getElementById('campaignTitle').value || 'Untitled Campaign';
                project.pitch = document.getElementById('campaignPitch').value;
                project.genre = document.getElementById('campaignGenre').value;
                project.tone = document.getElementById('campaignTone').value;
                project.scope = document.getElementById('campaignScope').value;
                project.structure = document.getElementById('campaignStructure').value;
                hideAllModals();
                renderAll();
            };
            
            window.startScenario = () => {
                resetProject();
                project.type = 'scenario';
                project.title = document.getElementById('scenarioTitle').value || 'Untitled Scenario';
                project.synopsis = document.getElementById('scenarioSynopsis').value;
                project.genre = document.getElementById('scenarioGenre').value;
                project.structure = document.getElementById('scenarioStructure').value;
                hideAllModals();
                renderAll();
            };

            // --- EVENT LISTENERS ---
            modeToggle.addEventListener('change', (e) => {
                body.classList.toggle('gm-mode', e.target.checked);
                body.classList.toggle('writer-mode', !e.target.checked);
                renderAll();
            });

            createNewProjectButton.addEventListener('click', () => {
                resetProject();
                renderAll();
                mainApp.classList.add('hidden');
                projectTypeModal.classList.remove('hidden');
                projectTypeModal.classList.add('flex');
            });

            // --- FILE MENU LOGIC ---
            fileMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!fileMenu.classList.contains('hidden')) {
                    fileMenu.classList.add('hidden');
                }
                // Close tag dropdown if clicking outside
                const dropdown = document.getElementById('tag-dropdown');
                if (dropdown && !dropdown.contains(e.target) && !e.target.matches('[data-editable-tag]')) {
                    closeTagDropdown();
                }
            });

            printPdfButton.addEventListener('click', (e) => {
                e.preventDefault();
                window.print();
                fileMenu.classList.add('hidden');
            });

            saveLocalButton.addEventListener('click', (e) => {
                e.preventDefault();
                const dataStr = JSON.stringify(project, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const safeTitle = project.title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeTitle || 'rpg-scenario-project'}.json`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                fileMenu.classList.add('hidden');
            });

            loadLocalButton.addEventListener('click', (e) => {
                e.preventDefault();
                loadFileInput.click();
                fileMenu.classList.add('hidden');
            });

            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (loadedData && typeof loadedData === 'object' && loadedData.hasOwnProperty('components')) {
                            project = loadedData;
                            if (!project.linkedCampaign) project.linkedCampaign = null;
                            nextId = Math.max(0, ...project.components.map(c => c.id)) + 1;
                            hideAllModals();
                            renderAll();
                        } else {
                            alert('Invalid project file format.');
                        }
                    } catch (error) {
                        console.error("Error parsing file:", error);
                        alert('Failed to load file. It might be corrupted or not a valid JSON file.');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            });

            // --- IN-PLACE EDITING & CAMPAIGN LINKING ---
            projectHeader.addEventListener('click', (e) => {
                // Edit Title
                if (e.target.matches('[data-editable-title]')) {
                    const titleElement = e.target;
                    const currentTitle = titleElement.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentTitle;
                    input.className = 'text-4xl font-bold bg-transparent border-b-2 border-blue-500 w-full text-gray-800 dark:text-white';
                    
                    titleElement.replaceWith(input);
                    input.focus();

                    const saveTitle = () => {
                        project.title = input.value || 'Untitled';
                        renderProjectHeader();
                    };

                    input.addEventListener('blur', saveTitle);
                    input.addEventListener('keydown', (ev) => {
                        if (ev.key === 'Enter') input.blur();
                        if (ev.key === 'Escape') {
                            input.value = currentTitle;
                            input.blur();
                        }
                    });
                }

                // Edit Tags with Dropdown
                if (e.target.matches('[data-editable-tag]')) {
                    const tagElement = e.target;
                    const key = tagElement.dataset.key;
                    let options;
                    if (project.type === 'campaign') {
                        options = projectOptions[`campaign${key.charAt(0).toUpperCase() + key.slice(1)}`];
                    } else {
                        options = projectOptions[`scenario${key.charAt(0).toUpperCase() + key.slice(1)}`];
                    }
                    if (!options) return;

                    showTagDropdown(tagElement, key, options);
                }
            });

            const showTagDropdown = (anchorElement, key, options) => {
                closeTagDropdown(); // Close any existing dropdowns first

                const dropdown = document.createElement('div');
                dropdown.id = 'tag-dropdown';
                dropdown.className = 'absolute mt-1 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-30 border border-gray-200 dark:border-gray-700';

                options.forEach(option => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.textContent = option;
                    item.className = 'block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700';
                    item.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        project[key] = option;
                        renderProjectHeader();
                        closeTagDropdown();
                    };
                    dropdown.appendChild(item);
                });

                const rect = anchorElement.getBoundingClientRect();
                const headerRect = projectHeader.getBoundingClientRect();
                dropdown.style.left = `${rect.left - headerRect.left}px`;
                dropdown.style.top = `${rect.bottom - headerRect.top}px`;

                projectHeader.appendChild(dropdown);
            };

            const closeTagDropdown = () => {
                const existingDropdown = document.getElementById('tag-dropdown');
                if (existingDropdown) {
                    existingDropdown.remove();
                }
            };

            sidebarExtras.addEventListener('click', (e) => {
                 if (e.target.matches('#linkCampaignButton')) {
                     linkCampaignFileInput.click();
                 }
                 if (e.target.matches('#unlinkCampaignButton')) {
                     project.linkedCampaign = null;
                     renderAll();
                 }
            });

            linkCampaignFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (loadedData && loadedData.type === 'campaign') {
                            project.linkedCampaign = loadedData;
                            renderAll();
                        } else {
                            alert('Invalid file. Please select a valid campaign JSON file.');
                        }
                    } catch (error) {
                        console.error("Error parsing campaign file:", error);
                        alert('Failed to load campaign file.');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            });


            // --- COMPONENT LOGIC ---
            window.addComponent = (type) => {
                if (!project.type) {
                    alert("Please create a new project first by clicking the '+' button.");
                    return;
                }
                const newComponent = { id: nextId++, type: type, data: getTemplateForType(type) };
                project.components.push(newComponent);
                renderContent();
            };
            
            window.deleteComponent = (id) => {
                project.components = project.components.filter(c => c.id !== id);
                renderContent();
            };

            window.saveComponent = (id) => {
                const component = project.components.find(c => c.id === id);
                if (!component) return;
                const form = document.querySelector(`[data-id='${id}']`);
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.dataset.key) {
                         component.data[input.dataset.key] = input.value;
                    }
                });
                renderContent();
            };

            const getTemplateForType = (type) => {
                switch (type) {
                    case 'story_arc': return { name: 'New Story Arc', summary: '', goal: '', key_antagonist: '', resolution: '' };
                    case 'adventure': return { name: 'New Adventure', hook: '', goal: '', stakes: '', resolution: '' };
                    case 'npc': return { name: 'New NPC', role: 'Quest Giver', goal: '', motivation: '', description: '', secrets_agenda: '', history: '' };
                    case 'location': return { name: 'New Location', type: 'City', description: '', atmosphere: '', key_features: '', inhabitants: '', secrets: '' };
                    case 'faction': return { name: 'New Faction', goals: '', ideology: '', key_members: '', resources: '', relationships: '' };
                    case 'encounter': return { name: 'New Encounter', type: 'Combat', description: '', setup: '', resolution: '' };
                    case 'item': return { name: 'Magic Item', rarity: 'Uncommon', description: '', properties: '', attunement: 'No' };
                    case 'clue': return { name: 'A Mysterious Clue', type: 'Physical Object', information: '', location_found: '', leads_to: '' };
                    default: return { name: 'New Component' };
                }
            };
            
            // --- RENDER FUNCTIONS ---
            const renderAll = () => {
                renderProjectHeader();
                renderContent();
                renderSidebarExtras();
            }

            const renderProjectHeader = () => {
                if (!project.type) {
                    projectHeader.innerHTML = '';
                    return;
                }
                let headerHTML = `<h2 data-editable-title class="editable-in-place text-4xl font-bold text-gray-800 dark:text-white mb-2 editable-title">${project.title}</h2>`;
                
                if (project.type === 'campaign') {
                    if (project.pitch) headerHTML += `<p class="prose-style text-lg text-gray-600 dark:text-gray-400 italic mb-4">${project.pitch}</p>`;
                    headerHTML += `<div class="flex flex-wrap gap-2 editable-in-place">
                        <span data-editable-tag data-key="genre" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">${project.genre}</span>
                        <span data-editable-tag data-key="tone" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">${project.tone}</span>
                        <span data-editable-tag data-key="structure" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">${project.structure}</span>
                        <span data-editable-tag data-key="scope" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200">${project.scope}</span>
                    </div>`;
                } else if (project.type === 'scenario') {
                    if (project.linkedCampaign) {
                        headerHTML += `<div class="mb-2 text-sm text-gray-500 dark:text-gray-400">Part of Campaign: <span class="font-semibold text-gray-700 dark:text-gray-300">${project.linkedCampaign.title}</span></div>`;
                    }
                    if (project.synopsis) headerHTML += `<p class="prose-style text-lg text-gray-600 dark:text-gray-400 italic mb-4">${project.synopsis}</p>`;
                     headerHTML += `<div class="flex flex-wrap gap-2 editable-in-place">
                        <span data-editable-tag data-key="structure" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">${project.structure}</span>
                        <span data-editable-tag data-key="genre" class="editable-tag inline-block px-3 py-1 text-sm font-semibold rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">${project.genre}</span>
                    </div>`;
                }
                projectHeader.innerHTML = headerHTML;
            };

            const renderSidebarExtras = () => {
                sidebarExtras.innerHTML = '';
                if (project.type === 'scenario') {
                    let buttonHTML = '';
                    if (project.linkedCampaign) {
                        buttonHTML = `<button id="unlinkCampaignButton" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-800 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                            Unlink Campaign
                        </button>`;
                    } else {
                        buttonHTML = `<button id="linkCampaignButton" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm bg-teal-100 text-teal-700 dark:bg-teal-900 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                            Link Campaign
                        </button>`;
                    }
                    sidebarExtras.innerHTML = `<h3 class="px-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 mt-4">Campaign</h3>${buttonHTML}`;
                }
            };

            const renderContent = () => {
                mainContent.innerHTML = '';
                if (!project.type) {
                    mainContent.innerHTML = `
                        <div class="text-center py-16 px-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No Project Loaded</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Click the '+' button to create a new campaign or scenario.</p>
                        </div>`;
                } else if (project.components.length === 0) {
                    mainContent.innerHTML = `
                        <div class="text-center py-16 px-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No components yet</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding a component from the sidebar.</p>
                        </div>`;
                } else {
                    project.components.forEach(component => {
                        const componentElement = document.createElement('div');
                        if (component.type === 'story_arc') {
                            componentElement.className = 'story-arc-card';
                        } else {
                            componentElement.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700';
                        }
                        componentElement.setAttribute('data-id', component.id);
                        componentElement.innerHTML = `
                            ${renderComponentHeader(component)}
                            <div class="mt-4">
                                ${renderWriterView(component)}
                                ${renderGmView(component)}
                            </div>
                        `;
                        mainContent.appendChild(componentElement);
                    });
                }
            };
            
            const renderComponentHeader = (component) => {
                const typeName = component.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const textColor = component.type === 'story_arc' ? 'text-white' : 'text-gray-800 dark:text-white';
                return `
                    <div class="flex justify-between items-center ${component.type !== 'story_arc' ? 'pb-3 border-b border-gray-200 dark:border-gray-700' : ''}">
                        <div>
                            <h3 class="text-2xl font-bold ${textColor}">${component.data.name || 'Untitled'}</h3>
                            <span class="text-xs font-semibold uppercase ${component.type === 'story_arc' ? 'text-blue-300' : 'text-gray-500 dark:text-gray-400'}">${typeName}</span>
                        </div>
                        <div class="editable no-print">
                             <button onclick="saveComponent(${component.id})" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Save</button>
                             <button onclick="deleteComponent(${component.id})" class="ml-2 text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Delete</button>
                        </div>
                    </div>
                `;
            };

            const renderWriterView = (component) => {
                let fields = '';
                for (const key in component.data) {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const labelColor = component.type === 'story_arc' ? 'text-gray-300' : 'text-gray-700 dark:text-gray-300';
                    const inputBg = component.type === 'story_arc' ? 'bg-gray-800' : 'bg-gray-50 dark:bg-gray-700';
                    const inputBorder = component.type === 'story_arc' ? 'border-gray-600' : 'border-gray-300 dark:border-gray-600';
                    const value = component.data[key];

                    if (key === 'rarity') {
                        fields += `<div><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><select data-key="${key}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500"><option>Common</option><option>Uncommon</option><option>Rare</option><option>Very Rare</option><option>Legendary</option></select></div>`;
                        const select = document.createElement('div');
                        select.innerHTML = fields;
                        select.querySelector('select').value = value;
                        fields = select.innerHTML;
                        continue;
                    }
                     if (key === 'attunement') {
                        fields += `<div><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><select data-key="${key}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500"><option>Yes</option><option>No</option></select></div>`;
                        const select = document.createElement('div');
                        select.innerHTML = fields;
                        select.querySelector('select').value = value;
                        fields = select.innerHTML;
                        continue;
                    }

                    if (['summary', 'description', 'properties', 'setup', 'resolution', 'goals', 'relationships', 'hook', 'stakes', 'secrets_agenda', 'history', 'atmosphere', 'key_features', 'inhabitants', 'secrets', 'ideology', 'resources', 'information'].includes(key)) {
                        fields += `<div><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><textarea data-key="${key}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500 prose-style" rows="4">${value}</textarea></div>`;
                    } else {
                         fields += `<div><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><input type="text" data-key="${key}" value="${value}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500"></div>`;
                    }
                }
                return `<div class="editable space-y-4">${fields}</div>`;
            };

            const renderGmView = (component) => {
                let fields = '';
                 for (const key in component.data) {
                    if(component.data[key]){
                         const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                         const labelColor = component.type === 'story_arc' ? 'text-blue-300' : 'text-gray-600 dark:text-gray-400';
                         const textColor = component.type === 'story_arc' ? 'text-gray-200' : 'text-gray-800 dark:text-gray-200';
                        fields += `
                            <div class="mb-3">
                                <h4 class="font-semibold ${labelColor}">${label}</h4>
                                <p class="prose-style ${textColor}">${component.data[key].replace(/\n/g, '<br>')}</p>
                            </div>
                        `;
                    }
                }
                return `<div class="viewable space-y-2">${fields}</div>`;
            };

            // Initial Load
            resetProject();
            renderAll();
        });
    </script>
</body>
</html>
