<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Scenario Guide - Book Layout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0;500;0;600;0;700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827; /* gray-900 */
            --panel-bg: #1f2937; /* gray-800 */
            --border-color: #374151; /* gray-700 */
            --text-color: #d1d5db; /* gray-300 */
            --text-muted: #9ca3af; /* gray-400 */
            --hover-bg: #374151; /* gray-700 */
            --active-bg: #4b5563; /* gray-600 */
            --active-text: #ffffff;
            --drop-indicator-color: #60a5fa; /* blue-400 */
            --link-color: #93c5fd; /* blue-300 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .book-prose {
            font-family: 'Lora', serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Lora', serif;
            font-weight: 600;
        }

        /* Main Layout */
        #app-container {
            display: grid;
            grid-template-columns: 300px 1fr 200px;
            height: 100vh;
            gap: 1.5rem;
            padding: 1.5rem;
            transition: grid-template-columns 0.3s ease;
        }
        #app-container.gm-mode {
            grid-template-columns: 300px 1fr 0;
        }
        #app-container.gm-mode #add-panel {
            display: none;
        }


        /* Panels */
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .panel-content {
            padding: 1rem;
            overflow-y: auto;
        }
        .panel-footer {
            padding: 0.5rem;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* Table of Contents */
        .toc-item {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: grab;
            transition: background-color 0.2s, padding-left 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }
        .toc-item:hover {
            background-color: var(--hover-bg);
        }
        .toc-item.active {
            background-color: var(--active-bg);
            font-weight: 600;
            color: var(--active-text);
        }
        .toc-item .handle {
            opacity: 0.3;
            cursor: grab;
            margin-right: 0.5rem;
        }
        .toc-item:hover .handle {
            opacity: 1;
        }
        .toc-item.dragging {
            opacity: 0.5;
            background-color: var(--active-bg);
        }
        .drop-target {
            border-top: 2px solid var(--drop-indicator-color) !important;
        }
        
        /* Nesting Lines */
        .toc-item-container {
            position: relative;
        }
        .nesting-line {
            position: absolute;
            left: 1.25rem; /* Adjust based on padding */
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: var(--border-color);
            z-index: 0;
        }
        .toc-item[data-level='0'] .nesting-line { display: none; }
        .toc-item-content {
            position: relative;
            padding-left: calc(var(--level, 0) * 1.5rem);
            flex-grow: 1;
        }


        /* Add Component Panel */
        .add-component-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .add-component-btn:hover {
            background-color: var(--hover-bg);
        }
        
        /* Nesting & Editing Controls */
        .writer-mode .viewable-content { display: none; }
        .gm-mode .editable-content { display: none; }
        .gm-mode .editable-control { display: none !important; }

        .nest-control-button:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        /* Main Content Panel */
        #main-panel .panel-content {
            padding: 2.5rem;
        }
        #mainContent .component-card {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 2rem;
            background-color: var(--panel-bg);
        }
        
        input, textarea {
            background-color: var(--panel-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        input:focus, textarea:focus {
            --tw-ring-color: var(--text-muted);
        }
        
        .map-container {
            position: relative;
            width: 100%;
            cursor: crosshair;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        .map-container img {
            display: block;
            max-width: 100%;
            border-radius: 0.5rem;
        }
        
        .component-link {
            color: var(--link-color);
            text-decoration: underline;
            text-decoration-style: dashed;
            cursor: pointer;
        }
        .component-link:hover {
            text-decoration-style: solid;
        }

        /* Quick Reference Panel */
        #quick-ref-panel {
            position: fixed;
            right: 1.5rem;
            top: 1.5rem;
            bottom: 1.5rem;
            width: 250px;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .gm-mode #quick-ref-panel {
            transform: translateX(0);
        }

        /* Mobile */
        @media (max-width: 1024px) {
            #app-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            #toc-panel, #add-panel, #quick-ref-panel {
                display: none; /* Hide side panels on smaller screens */
            }
        }
    </style>
</head>
<body>

    <div id="app-container" class="writer-mode">
        <aside id="toc-panel" class="panel">
            <div class="panel-header flex justify-between items-center">
                <h2 class="text-xl font-bold">Table of Contents</h2>
                <button id="undoButton" title="Undo Last Action" class="p-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                    </svg>
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <input type="text" id="toc-filter" placeholder="Filter components..." class="w-full bg-gray-900 border border-gray-700 rounded-md px-2 py-1 text-sm">
            </div>
            <div id="toc-list" class="panel-content space-y-1">
                </div>
            <div class="panel-footer">
                <button id="gmViewButton" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-white font-semibold">GM View</button>
            </div>
        </aside>

        <main id="main-panel" class="panel">
             <div class="panel-header flex justify-between items-center">
                 <div class="flex items-center gap-4">
                     <h1 id="project-title-display" class="text-2xl font-bold">New Project</h1>
                     <div class="flex items-center gap-2">
                         <button id="saveLocalButton" title="Save Project" class="p-2 rounded-md hover:bg-gray-700">
                             <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                         </button>
                         <button id="loadLocalButton" title="Load Project" class="p-2 rounded-md hover:bg-gray-700">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                         </button>
                     </div>
                 </div>
             </div>
            <div id="main-scroll-area" class="panel-content book-prose">
                <div id="projectHeader" class="mb-12"></div>
                <div id="mainContent" class="space-y-8">
                    </div>
            </div>
        </main>

        <aside id="add-panel" class="panel">
            <div class="panel-header">
                <h2 class="text-xl font-bold">Component</h2>
            </div>
            <div id="add-component-list" class="panel-content">
                </div>
        </aside>
    </div>
    
    <aside id="quick-ref-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">Quick Reference</h2>
        </div>
        <div id="quick-ref-list" class="panel-content"></div>
    </aside>

    <div id="mobileMessage" class="hidden lg:hidden flex-col items-center justify-center h-screen text-center p-4 bg-gray-900 text-gray-300">
        <h2 class="text-2xl font-bold mb-2 font-serif">RPG Scenario Guide</h2>
        <p>This application is designed for a larger screen. Please use a desktop or tablet for the best experience.</p>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full text-center">
            <h3 id="confirmTitle" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirmMessage" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelButton" class="px-6 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500">Cancel</button>
                <button id="confirmOkButton" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full flex flex-col" style="height: 90vh;">
            <h2 class="text-2xl font-bold text-white mb-4">Import Components</h2>
            <p class="text-gray-400 mb-4">Select the components you wish to import into your current project.</p>
            <div id="import-options-list" class="flex-grow overflow-y-auto border border-gray-700 rounded-lg p-4">
                <!-- Import options will be rendered here -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="importCancelButton" class="px-6 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500">Cancel</button>
                <button id="importConfirmButton" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Import Selected</button>
            </div>
        </div>
    </div>

    <input type="file" id="loadFileInput" class="hidden" accept=".json">
    <input type="file" id="mapImageInput" class="hidden" accept="image/*">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let project = {};
            let nextId = 1;
            let activeComponentId = null;
            let historyStack = [];
            let draggingItemId = null;
            let confirmCallback = null;
            let isFullViewActive = false;
            let loadedProjectData = null;

            // --- DOM ELEMENTS ---
            const mainApp = document.getElementById('app-container');
            const mobileMessage = document.getElementById('mobileMessage');
            const mainContent = document.getElementById('mainContent');
            const projectHeader = document.getElementById('projectHeader');
            const saveLocalButton = document.getElementById('saveLocalButton');
            const loadLocalButton = document.getElementById('loadLocalButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const mapImageInput = document.getElementById('mapImageInput');
            const addComponentList = document.getElementById('add-component-list');
            const tocList = document.getElementById('toc-list');
            const tocFilterInput = document.getElementById('toc-filter');
            const projectTitleDisplay = document.getElementById('project-title-display');
            const undoButton = document.getElementById('undoButton');
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOkButton = document.getElementById('confirmOkButton');
            const confirmCancelButton = document.getElementById('confirmCancelButton');
            const gmViewButton = document.getElementById('gmViewButton');
            const quickRefList = document.getElementById('quick-ref-list');
            const importModal = document.getElementById('importModal');
            const importOptionsList = document.getElementById('import-options-list');
            const importCancelButton = document.getElementById('importCancelButton');
            const importConfirmButton = document.getElementById('importConfirmButton');

            // --- HELPER FUNCTIONS (DEFINED EARLY) ---
            const findComponentAndParent = (id, components = project.components, parent = null) => {
                for (let i = 0; i < components.length; i++) {
                    const component = components[i];
                    if (component.id === id) {
                        return { component, parent, index: i };
                    }
                    if (component.children) {
                        const found = findComponentAndParent(id, component.children, component);
                        if (found) return found;
                    }
                }
                return null;
            };

            const getAllComponents = (components) => {
                return components.reduce((acc, comp) => {
                    acc.push(comp);
                    if (comp.children) {
                        acc.push(...getAllComponents(comp.children));
                    }
                    return acc;
                }, []);
            };
            
            const findComponent = (id) => {
                const result = findComponentAndParent(id);
                return result ? result.component : null;
            };

            const linkify = (text) => {
                const allComponents = getAllComponents(project.components);
                return text.replace(/\[\[(.*?)\]\]/g, (match, componentName) => {
                    const target = allComponents.find(c => c.data.name.toLowerCase() === componentName.toLowerCase());
                    if (target) {
                        return `<a href="#" class="component-link" data-link-id="${target.id}">${componentName}</a>`;
                    }
                    return match; // Return original text if no match
                });
            };

            // --- INITIALIZATION ---
            function initializeApp() {
                if (window.innerWidth < 1024) {
                    mainApp.style.display = 'none';
                    mobileMessage.style.display = 'flex';
                } else {
                    mainApp.style.display = 'grid';
                    mobileMessage.style.display = 'none';
                    resetProject();
                }
            }

            // --- MODAL & HISTORY MANAGEMENT ---
            const showConfirm = (message, callback) => {
                confirmMessage.textContent = message;
                confirmCallback = callback;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            };

            const closeConfirm = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                confirmCallback = null;
            };

            const saveStateToHistory = () => {
                historyStack.push(structuredClone(project));
                if (historyStack.length > 20) historyStack.shift();
                updateUndoButtonState();
            };

            const undoLastAction = () => {
                if (historyStack.length > 0) {
                    project = historyStack.pop();
                    nextId = Math.max(0, ...getAllComponents(project.components).map(c => c.id)) + 1 || 1;
                    if (!getAllComponents(project.components).some(c => c.id === activeComponentId)) {
                        activeComponentId = project.components.length > 0 ? project.components[0].id : null;
                    }
                    renderAll();
                }
            };

            const updateUndoButtonState = () => {
                if (undoButton) undoButton.disabled = historyStack.length === 0;
            };

            // --- PROJECT & COMPONENT LOGIC ---
            const resetProject = () => {
                project = {
                    title: 'New Project',
                    pitch: 'A brief, one-paragraph pitch for the campaign or adventure.',
                    components: []
                };
                nextId = 1;
                activeComponentId = null;
                historyStack = [];
                isFullViewActive = false;
                renderAll();
            };

            const addComponent = (type) => {
                saveStateToHistory();
                const newComponent = { id: nextId++, type, data: getTemplateForType(type), children: [] };
                project.components.push(newComponent);
                activeComponentId = newComponent.id;
                isFullViewActive = false;
                renderAll();
            };

            const deleteComponent = (id) => {
                saveStateToHistory();
                
                const removeRecursively = (components, targetId) => {
                    for (let i = components.length - 1; i >= 0; i--) {
                        if (components[i].id === targetId) {
                            components.splice(i, 1);
                            return true;
                        }
                        if (components[i].children && removeRecursively(components[i].children, targetId)) {
                            return true;
                        }
                    }
                    return false;
                };

                removeRecursively(project.components, id);

                if (activeComponentId === id) {
                    activeComponentId = project.components.length > 0 ? project.components[0].id : null;
                    isFullViewActive = false;
                }
                renderAll();
            };

            const getTemplateForType = (type) => {
                const templates = {
                    'Story Arc': { name: 'New Story Arc', summary: '', goal: '', 'Key Antagonist': '', resolution: '', tags: '' },
                    'Adventure': { name: 'New Adventure', hook: '', goal: '', stakes: '', resolution: '', tags: '' },
                    'NPC': { name: 'New NPC', role: 'Quest Giver', appearance: '', motivation: 'To acquire wealth.', secrets: '', 'plot_hooks': '', tags: '' },
                    'Location': { name: 'New Location', type: 'City', description: '', atmosphere: '', 'key_sights': '', 'sounds_and_smells': '', 'potential_encounters': '', secrets: '', tags: '' },
                    'Faction': { name: 'New Faction', goals: 'Gain political control.', ideology: '', key_members: '', resources: '', tags: '' },
                    'Encounter': { name: 'New Encounter', type: 'Combat', description: '', setup: '', resolution: '', tags: '' },
                    'Item': { name: 'New Item', rarity: 'Uncommon', attunement: 'No', description: '', properties: '', history: '', tags: '' },
                    'Clue': { name: 'New Clue', information: '', location_found: '', conclusion: '', tags: '' },
                    'Map': { name: 'New Map', description: '', imageUrl: null, tags: '' },
                };
                return templates[type] || { name: `New ${type}`, tags: '' };
            };

            // --- RENDER FUNCTIONS ---
            const renderAll = () => {
                updateUndoButtonState();
                renderProjectHeader();
                renderTableOfContents();
                renderAddComponentSidebar();
                renderActiveComponent();
                projectTitleDisplay.textContent = project.title || 'Untitled Project';
            };

            const renderProjectHeader = () => {
                const headerContent = `
                    <div class="editable-content">
                        <input type="text" data-key="title" value="${project.title}" placeholder="Project Title" class="text-4xl font-bold w-full bg-transparent border-b-2 border-transparent focus:border-gray-600 outline-none pb-2 transition-colors">
                        <textarea data-key="pitch" placeholder="Project Pitch..." class="book-prose text-lg w-full bg-transparent border-b-2 border-transparent focus:border-gray-600 outline-none p-2 mt-4" rows="3">${project.pitch}</textarea>
                    </div>
                    <div class="viewable-content">
                        <h1 class="text-4xl font-bold mb-4">${project.title}</h1>
                        <p class="book-prose text-lg italic text-gray-400">${linkify(project.pitch)}</p>
                    </div>
                `;
                projectHeader.innerHTML = headerContent;
            };

            const renderTableOfContents = () => {
                tocList.innerHTML = '';
                const filterText = tocFilterInput.value.toLowerCase();
                
                const filterAndBuild = (components) => {
                    const filtered = [];
                    for(const component of components) {
                        const selfMatch = component.data.name.toLowerCase().includes(filterText) ||
                                        (component.data.tags && component.data.tags.toLowerCase().includes(filterText));
                        const children = component.children ? filterAndBuild(component.children) : [];

                        if(selfMatch || children.length > 0) {
                            filtered.push({
                                ...component,
                                children: children
                            });
                        }
                    }
                    return filtered;
                }

                const componentsToRender = filterText ? filterAndBuild(project.components) : project.components;

                if (componentsToRender.length === 0) {
                    tocList.innerHTML = `<p class="text-sm text-gray-400 px-1">No matching components.</p>`;
                    return;
                }

                const renderItems = (components, level = 0) => {
                    components.forEach((component) => {
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'toc-item-container';
                        
                        const item = document.createElement('div');
                        item.className = `toc-item ${component.id === activeComponentId && !isFullViewActive ? 'active' : ''}`;
                        item.dataset.id = component.id;
                        item.draggable = true;
                        
                        const itemContent = document.createElement('div');
                        itemContent.className = 'toc-item-content';
                        itemContent.style.setProperty('--level', level);
                        itemContent.innerHTML = `
                            <span class="handle text-gray-500">â ¿</span>
                            <span class="truncate">${component.data.name}</span>
                        `;

                        item.appendChild(itemContent);
                        itemContainer.appendChild(item);
                        tocList.appendChild(itemContainer);

                        if (component.children && component.children.length > 0) {
                            const childrenContainer = document.createElement('div');
                            childrenContainer.className = 'toc-children-container relative';
                            const line = document.createElement('div');
                            line.className = 'nesting-line';
                            childrenContainer.appendChild(line);
                            renderItems(component.children, level + 1).forEach(childEl => childrenContainer.appendChild(childEl));
                            itemContainer.appendChild(childrenContainer);
                        }
                    });
                    return components.map(c => tocList.querySelector(`[data-id='${c.id}']`).parentElement);
                };
                renderItems(componentsToRender);
            };

            const renderAddComponentSidebar = () => {
                const componentTypes = ['Story Arc', 'Adventure', 'NPC', 'Location', 'Faction', 'Encounter', 'Item', 'Clue', 'Map'];
                addComponentList.innerHTML = componentTypes.map(type => `
                    <button class="add-component-btn" data-type="${type}">${type}</button>
                `).join('');
            };

            const renderActiveComponent = () => {
                mainContent.innerHTML = '';
                if (isFullViewActive) {
                    renderAllComponentsView();
                    renderQuickReferencePanel();
                    return;
                }

                const activeInfo = findComponentAndParent(activeComponentId);
                if (!activeInfo) {
                    mainContent.innerHTML = `<div class="text-center text-gray-500 py-16">Select a component from the Table of Contents to begin.</div>`;
                    return;
                }
                const { component, parent, index } = activeInfo;

                const card = document.createElement('div');
                card.className = 'component-card';
                card.dataset.id = component.id;

                let fieldsHTML = '';
                if (component.type === 'Map') {
                     fieldsHTML = `
                        <div class="editable-content">
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-500 mb-1">Name</label>
                                <input type="text" data-key="name" value="${component.data.name}" class="w-full p-2 bg-transparent border-b-2 border-gray-700 focus:border-gray-400 outline-none transition">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-500 mb-1">Description</label>
                                <textarea data-key="description" class="w-full p-2 bg-transparent border-b-2 border-gray-700 focus:border-gray-400 outline-none transition">${component.data.description || ''}</textarea>
                            </div>
                            <button data-action="uploadMap" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-white">Upload Map Image</button>
                        </div>
                        <div class="viewable-content">
                            <p class="book-prose mt-1">${linkify(component.data.description || '')}</p>
                        </div>
                        ${component.data.imageUrl ? `<div class="mt-4 map-container"><img src="${component.data.imageUrl}"></div>` : ''}
                    `;
                } else {
                    for (const key in component.data) {
                        if (key === 'tags') continue;
                        const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                        const value = component.data[key] || '';
                        const isTextArea = ['summary', 'description', 'pitch', 'hook', 'stakes', 'resolution', 'motivation', 'atmosphere', 'secrets', 'goals', 'ideology', 'key_members', 'setup', 'properties', 'information', 'conclusion', 'plot_hooks', 'key_sights', 'sounds_and_smells', 'potential_encounters', 'history'].includes(key);
                        
                        fieldsHTML += `
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-500 mb-1">${label}</label>
                                <div class="editable-content">
                                    ${isTextArea 
                                        ? `<textarea data-key="${key}" class="w-full p-2 bg-transparent border-b-2 border-gray-700 focus:border-gray-400 outline-none transition">${value}</textarea>`
                                        : `<input type="text" data-key="${key}" value="${value}" class="w-full p-2 bg-transparent border-b-2 border-gray-700 focus:border-gray-400 outline-none transition">`
                                    }
                                </div>
                                <p class="viewable-content book-prose mt-1">${linkify(String(value).replace(/\n/g, '<br>'))}</p>
                            </div>
                        `;
                    }
                }
                
                // Tags field at the end
                fieldsHTML += `
                     <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-500 mb-1">Tags</label>
                        <input type="text" data-key="tags" value="${component.data.tags || ''}" class="editable-content w-full p-2 bg-transparent border-b-2 border-gray-700 focus:border-gray-400 outline-none transition" placeholder="comma, separated, tags">
                        <p class="viewable-content book-prose mt-1">${component.data.tags || 'No tags'}</p>
                    </div>
                `;
                
                const parentArray = parent ? parent.children : project.components;
                const canIndent = index > 0;
                const canOutdent = parent !== null;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h2 class="text-3xl font-bold">${component.data.name}</h2>
                            <div class="editable-control flex items-center gap-2 mt-2">
                                <button data-action="outdent" title="Outdent Component" class="nest-control-button p-1 hover:bg-gray-700 rounded-md" ${!canOutdent ? 'disabled' : ''}>
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 9l-3 3m0 0l3 3m-3-3h7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </button>
                                <button data-action="indent" title="Indent Component" class="nest-control-button p-1 hover:bg-gray-700 rounded-md" ${!canIndent ? 'disabled' : ''}>
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15l3-3m0 0l-3-3m3 3h-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </button>
                            </div>
                        </div>
                        <button data-action="deleteComponent" class="editable-control text-sm text-red-500 hover:text-red-400 transition-colors">Delete Component</button>
                    </div>
                    ${fieldsHTML}
                `;
                mainContent.appendChild(card);
            };

            const renderAllComponentsView = () => {
                let html = '';
                const traverseAndRender = (components, level = 0) => {
                    components.forEach(component => {
                        let fieldsHTML = '';
                        for (const key in component.data) {
                            if (key === 'name' || key === 'imageUrl') continue;
                            const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            const value = String(component.data[key]).replace(/\n/g, '<br>');
                            if(value) {
                                fieldsHTML += `<div class="mb-4"><h4 class="font-bold text-gray-400">${label}</h4><p class="book-prose">${linkify(value)}</p></div>`;
                            }
                        }
                        if (component.data.imageUrl) {
                            fieldsHTML += `<div class="mt-4 map-container"><img src="${component.data.imageUrl}"></div>`;
                        }
                        
                        html += `
                            <div class="component-card mb-8" id="component-card-${component.id}" style="margin-left: ${level * 2}rem;">
                                <h2 class="text-3xl font-bold mb-4 border-b border-gray-700 pb-2">${component.data.name}</h2>
                                ${fieldsHTML}
                            </div>
                        `;

                        if (component.children && component.children.length > 0) {
                            traverseAndRender(component.children, level + 1);
                        }
                    });
                };
                traverseAndRender(project.components);
                mainContent.innerHTML = html;
            };
            
            const renderQuickReferencePanel = () => {
                quickRefList.innerHTML = '';
                const keyComponents = getAllComponents(project.components).filter(c => c.type === 'NPC' || c.type === 'Location');
                if (keyComponents.length === 0) {
                    quickRefList.innerHTML = `<p class="text-sm text-gray-400">No NPCs or Locations found.</p>`;
                    return;
                }
                
                let listHtml = '<div class="space-y-2">';
                listHtml += '<h3 class="font-bold text-lg">NPCs</h3>';
                keyComponents.filter(c => c.type === 'NPC').forEach(c => {
                    listHtml += `<div><a href="#" class="quick-ref-link" data-scroll-to-id="${c.id}">${c.data.name}</a></div>`;
                });

                listHtml += '<h3 class="font-bold text-lg mt-4">Locations</h3>';
                keyComponents.filter(c => c.type === 'Location').forEach(c => {
                    listHtml += `<div><a href="#" class="quick-ref-link" data-scroll-to-id="${c.id}">${c.data.name}</a></div>`;
                });

                listHtml += '</div>';
                quickRefList.innerHTML = listHtml;
            };


            // --- EVENT LISTENERS ---
            window.addEventListener('resize', initializeApp);
            undoButton.addEventListener('click', undoLastAction);
            saveLocalButton.addEventListener('click', () => {
                const dataStr = JSON.stringify(project, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project.title.replace(/[^a-z0-9]/gi, '_') || 'rpg-project'}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
            loadLocalButton.addEventListener('click', () => loadFileInput.click());
            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        loadedProjectData = JSON.parse(event.target.result);
                        if (loadedProjectData && loadedProjectData.title && loadedProjectData.components) {
                           renderImportModal(loadedProjectData);
                        } else {
                            alert('Invalid project file.');
                        }
                    } catch {
                        alert('Error reading file.');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            addComponentList.addEventListener('click', (e) => {
                if (e.target.matches('.add-component-btn')) {
                    addComponent(e.target.dataset.type);
                }
            });

            tocList.addEventListener('click', (e) => {
                const tocItem = e.target.closest('.toc-item');
                if (tocItem) {
                    activeComponentId = parseInt(tocItem.dataset.id);
                    isFullViewActive = false;
                    mainApp.classList.remove('gm-mode');
                    mainApp.classList.add('writer-mode');
                    renderAll();
                }
            });
            
            gmViewButton.addEventListener('click', () => {
                isFullViewActive = true;
                activeComponentId = null;
                mainApp.classList.add('gm-mode');
                mainApp.classList.remove('writer-mode');
                renderAll();
            });
            
            confirmOkButton.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                closeConfirm();
            });
            confirmCancelButton.addEventListener('click', closeConfirm);

            mainContent.addEventListener('input', (e) => {
                if (e.target.matches('[data-key]')) {
                    const component = findComponent(activeComponentId);
                    if (component) {
                        component.data[e.target.dataset.key] = e.target.value;
                        if(e.target.dataset.key === 'name') {
                            renderTableOfContents();
                            const cardHeader = mainContent.querySelector(`.component-card[data-id='${activeComponentId}'] h2`);
                            if (cardHeader) {
                                cardHeader.textContent = e.target.value;
                            }
                        }
                    }
                }
            });
            mainContent.addEventListener('focusout', (e) => { if (e.target.matches('[data-key]')) saveStateToHistory(); });

            projectHeader.addEventListener('input', (e) => {
                if (e.target.matches('[data-key]')) {
                    project[e.target.dataset.key] = e.target.value;
                     if(e.target.dataset.key === 'title') {
                        projectTitleDisplay.textContent = project.title;
                    }
                }
            });
            projectHeader.addEventListener('focusout', (e) => { if (e.target.matches('[data-key]')) saveStateToHistory(); });
            
            mainContent.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget) {
                    const action = actionTarget.dataset.action;

                    if (action === 'deleteComponent') {
                        showConfirm('Are you sure you want to delete this component and all its sub-components?', () => {
                            deleteComponent(activeComponentId);
                        });
                    }
                    if (action === 'uploadMap') {
                        mapImageInput.click();
                    }
                    if(action === 'indent') {
                        indentComponent(activeComponentId);
                    }
                    if(action === 'outdent') {
                        outdentComponent(activeComponentId);
                    }
                } else {
                    const linkTarget = e.target.closest('.component-link');
                    if(linkTarget) {
                        e.preventDefault();
                        const linkId = parseInt(linkTarget.dataset.linkId);
                        activeComponentId = linkId;
                        isFullViewActive = false;
                        mainApp.classList.remove('gm-mode');
                        mainApp.classList.add('writer-mode');
                        renderAll();
                    }
                }
            });
            
            quickRefList.addEventListener('click', (e) => {
                if(e.target.matches('.quick-ref-link')) {
                    e.preventDefault();
                    const targetId = e.target.dataset.scrollToId;
                    const targetElement = document.getElementById(`component-card-${targetId}`);
                    if(targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            });
            
            mapImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const component = findComponent(activeComponentId);
                    if (component && component.type === 'Map') {
                        saveStateToHistory();
                        component.data.imageUrl = event.target.result;
                        renderActiveComponent();
                    }
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            });

            tocFilterInput.addEventListener('input', renderTableOfContents);

            // --- HIERARCHY AND DRAG/DROP LOGIC (REWRITTEN) ---
            const indentComponent = (id) => {
                const info = findComponentAndParent(id);
                if (!info || info.index === 0) return;
                
                const parentArray = info.parent ? info.parent.children : project.components;
                const newParent = parentArray[info.index - 1];
                if (!newParent) return;

                saveStateToHistory();
                const [itemToIndent] = parentArray.splice(info.index, 1);
                newParent.children.push(itemToIndent);
                renderAll();
            };

            const outdentComponent = (id) => {
                const info = findComponentAndParent(id);
                if (!info || !info.parent) return;

                const grandParentInfo = findComponentAndParent(info.parent.id);
                if (!grandParentInfo) return; 

                saveStateToHistory();
                const sourceArray = info.parent.children;
                const [itemToOutdent] = sourceArray.splice(info.index, 1);
                
                const destinationArray = grandParentInfo.parent ? grandParentInfo.parent.children : project.components;
                destinationArray.splice(grandParentInfo.index + 1, 0, itemToOutdent);
                renderAll();
            };

            const moveComponent = (draggedId, targetId) => {
                if (draggedId === targetId) return;
                saveStateToHistory();

                const draggedInfo = findComponentAndParent(draggedId);
                if (!draggedInfo) return;
                
                const sourceArray = draggedInfo.parent ? draggedInfo.parent.children : project.components;
                const [draggedItem] = sourceArray.splice(draggedInfo.index, 1);
                
                const targetInfo = findComponentAndParent(targetId);
                if (!targetInfo) { 
                    project.components.push(draggedItem);
                } else {
                    const targetArray = targetInfo.parent ? targetInfo.parent.children : project.components;
                    targetArray.splice(targetInfo.index, 0, draggedItem);
                }

                renderAll();
            };

            tocList.addEventListener('dragstart', e => {
                const target = e.target.closest('.toc-item');
                if (target) {
                    draggingItemId = parseInt(target.dataset.id);
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => target.classList.add('dragging'), 0);
                }
            });

            tocList.addEventListener('dragend', e => {
                draggingItemId = null;
                document.querySelectorAll('.toc-item').forEach(el => {
                    el.classList.remove('dragging', 'drop-target');
                });
            });
            
            tocList.addEventListener('dragover', e => {
                e.preventDefault();
                const dropTargetElement = e.target.closest('.toc-item');
                if (!dropTargetElement) return;

                document.querySelectorAll('.toc-item').forEach(el => {
                    el.classList.remove('drop-target');
                });
                
                dropTargetElement.classList.add('drop-target');
            });

            tocList.addEventListener('drop', e => {
                e.preventDefault();
                const dropTargetElement = e.target.closest('.toc-item');
                document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('drop-target'));
                if (!dropTargetElement || draggingItemId === null) return;
                
                const dropTargetId = parseInt(dropTargetElement.dataset.id);
                moveComponent(draggingItemId, dropTargetId);
            });
            
            // --- IMPORT LOGIC ---
            const renderImportModal = (data) => {
                let html = `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-md">
                        <input type="checkbox" data-import-key="title" checked class="h-4 w-4 rounded border-gray-600 text-blue-500 focus:ring-blue-500">
                        <span class="font-bold">Project Title: ${data.title}</span>
                    </label>
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-md">
                        <input type="checkbox" data-import-key="pitch" checked class="h-4 w-4 rounded border-gray-600 text-blue-500 focus:ring-blue-500">
                        <span class="font-bold">Project Pitch</span>
                    </label>
                    <hr class="border-gray-600 my-4">
                `;

                const renderImportItems = (components, level = 0) => {
                    components.forEach(component => {
                        html += `
                            <label class="flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-md" style="padding-left: ${1 + level * 1.5}rem;">
                                <input type="checkbox" data-import-id="${component.id}" checked class="h-4 w-4 rounded border-gray-600 text-blue-500 focus:ring-blue-500">
                                <span>${component.data.name} <span class="text-sm text-gray-400">(${component.type})</span></span>
                            </label>
                        `;
                        if (component.children && component.children.length > 0) {
                            renderImportItems(component.children, level + 1);
                        }
                    });
                };
                renderImportItems(data.components);
                importOptionsList.innerHTML = html;
                importModal.classList.remove('hidden');
                importModal.classList.add('flex');
            };
            
            importCancelButton.addEventListener('click', () => {
                importModal.classList.add('hidden');
                importModal.classList.remove('flex');
                loadedProjectData = null;
            });

            importConfirmButton.addEventListener('click', () => {
                if (!loadedProjectData) return;
                saveStateToHistory();

                const importTitle = document.querySelector('[data-import-key="title"]').checked;
                const importPitch = document.querySelector('[data-import-key="pitch"]').checked;

                if (importTitle) project.title = loadedProjectData.title;
                if (importPitch) project.pitch = loadedProjectData.pitch;

                const remapIdsAndFilter = (components) => {
                    const newComponents = [];
                    components.forEach(comp => {
                        const checkbox = document.querySelector(`[data-import-id="${comp.id}"]`);
                        if (checkbox && checkbox.checked) {
                            const newComp = structuredClone(comp);
                            newComp.id = nextId++;
                            if (newComp.children) {
                                newComp.children = remapIdsAndFilter(newComp.children);
                            }
                            newComponents.push(newComp);
                        }
                    });
                    return newComponents;
                };

                const componentsToImport = remapIdsAndFilter(loadedProjectData.components);
                project.components.push(...componentsToImport);
                
                importModal.classList.add('hidden');
                importModal.classList.remove('flex');
                loadedProjectData = null;
                renderAll();
            });


            // --- INITIALIZE ---
            initializeApp();
        });
    </script>
</body>
</html>
