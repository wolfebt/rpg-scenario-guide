<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Scenario & Map Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- General Scenario Guide Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Default light mode background */
        }
        body.dark {
             background-color: #111827; /* Default dark mode background */
        }
        .prose-style {
            font-family: 'Lora', serif;
        }
        .gm-mode .editable {
            display: none;
        }
        .writer-mode .viewable {
            display: none;
        }
        .sidebar-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4299e1;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .story-arc-card {
            background-color: #1a202c;
            border-left: 4px solid #4299e1;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        /* Style for disabled sidebar buttons */
        .sidebar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            color: #9ca3af !important;
        }
        .sidebar-btn:disabled:hover {
            background-color: transparent !important;
        }


        /* --- Map Maker Styles (Scoped) --- */
        #mapMakerContainer {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #1f2937;
            color: #d1d5db;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        #mapMakerContainer #main-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #mapMakerContainer #canvas-container {
            position: absolute;
            inset: 0;
            padding: 1rem;
        }
        #mapMakerContainer #mapCanvas {
            cursor: crosshair;
            background-color: #374151;
            border-radius: 0.5rem;
            display: block;
            width: 100%;
            height: 100%;
        }
        #mapMakerContainer #mapCanvas.panning { cursor: grab; }
        #mapMakerContainer #mapCanvas.erasing { cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-delete'><path d='M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z'></path><line x1='18' y1='9' x2='12' y2='15'></line><line x1='12' y1='9' x2='18' y2='15'></line></svg>") 16 16, auto; }
        #mapMakerContainer #panelWrapper {
            position: absolute; top: 0; right: 0; height: 100%; display: flex; align-items: flex-start; z-index: 10; pointer-events: none;
        }
        #mapMakerContainer .control-container {
            background-color: #111827; color: #d1d5db; width: 20rem; height: 100%; transform: translateX(100%); transition: transform 0.3s ease-in-out; flex-shrink: 0; pointer-events: auto;
        }
        #mapMakerContainer .control-container.open { transform: translateX(0%); }
        #mapMakerContainer .control-panel {
            background-color: #1f2937; border: 1px solid #374151; padding: 1rem; border-radius: 0.5rem;
        }
        #mapMakerContainer .control-panel h3 { font-weight: 700; margin-bottom: 0; color: #f9fafb; }
        #mapMakerContainer .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; padding-bottom: 0.5rem; }
        #mapMakerContainer .collapsible-header svg { transition: transform 0.3s; }
        #mapMakerContainer .collapsible-header.collapsed svg { transform: rotate(-90deg); }
        #mapMakerContainer .collapsible-content { padding-top: 0.75rem; }
        #mapMakerContainer .collapsible-content.hidden { display: none; }
        #mapMakerContainer .control-panel label { font-weight: 500; margin-bottom: 0.25rem; display: block; }
        #mapMakerContainer .control-panel input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #4b5563; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        #mapMakerContainer .control-panel input[type="range"]:hover { opacity: 1; }
        #mapMakerContainer .control-panel input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        #mapMakerContainer .control-panel input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        #mapMakerContainer .control-panel select, #mapMakerContainer .control-panel button, #mapMakerContainer .control-panel input[type="number"], #mapMakerContainer .control-panel input[type="text"], #mapMakerContainer .control-panel textarea, #mapMakerContainer .control-panel input[type="color"] { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #4b5563; background-color: #374151; color: #f9fafb; margin-bottom: 0.75rem; transition: all 0.2s; }
        #mapMakerContainer .control-panel textarea { min-height: 80px; }
        #mapMakerContainer .control-panel input[type="color"] { padding: 0.25rem; }
        #mapMakerContainer .control-panel button { display: flex; align-items: center; justify-content: center; }
        #mapMakerContainer .control-panel button:hover { background-color: #4b5563; }
        #mapMakerContainer .control-panel.active { background-color: #1e40af; border-color: #3b82f6; }
        #mapMakerContainer .control-panel button.active { background-color: #3b82f6; }
        #mapMakerContainer .control-panel button:disabled { background-color: #4b5563; cursor: not-allowed; opacity: 0.5; }
        #mapMakerContainer .file-dropdown { position: absolute; background-color: #1f2937; border: 1px solid #374151; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 50; width: 200px; }
        #mapMakerContainer .file-dropdown-item { padding: 0.75rem 1rem; cursor: pointer; display: block; width: 100%; text-align: left; }
        #mapMakerContainer .file-dropdown-item:hover { background-color: #374151; }
        #mapMakerContainer .item-container, #mapMakerContainer .layer-item { display: flex; flex-direction: row; align-items: center; padding: 0.5rem; border-radius: 0.375rem; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        #mapMakerContainer .item-container.active, #mapMakerContainer .layer-item.active { border-color: #3b82f6; background-color: #374151; }
        #mapMakerContainer .item-container:hover, #mapMakerContainer .layer-item:hover { background-color: #374151; }
        #mapMakerContainer .texture-swatch, #mapMakerContainer .object-swatch { width: 32px; height: 32px; border-radius: 0.375rem; border: 1px solid #4b5563; flex-shrink: 0; }
        #mapMakerContainer .object-swatch { display: flex; align-items: center; justify-content: center; font-size: 24px; }
        #mapMakerContainer .item-label, #mapMakerContainer .layer-label { margin-left: 0.75rem; font-size: 14px; text-align: left; flex-grow: 1; }
        #mapMakerContainer .layer-controls { display: flex; gap: 0.25rem; }
        #mapMakerContainer .layer-controls button { padding: 0.25rem; background: none; border: none; color: #9ca3af; }
        #mapMakerContainer .layer-controls button:hover { color: #f9fafb; background: #4b5563; }
        #mapMakerContainer .collapsed-bar { writing-mode: vertical-rl; transform: rotate(180deg); background-color: #111827; color: #d1d5db; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0.5rem 0 0 0.5rem; display: flex; align-items: center; justify-content: center; letter-spacing: 2px; font-weight: bold; flex-shrink: 0; transition: all 0.3s ease-in-out; height: 200px; margin-top: 1rem; pointer-events: auto; }
        #mapMakerContainer .collapsed-bar.hidden { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #mapMakerContainer .spinner { border-radius: 50%; width: 1.25rem; height: 1.25rem; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; animation: spin 1s linear infinite; }
        #mapMakerContainer .map-popup { position: absolute; background: #111827; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; z-index: 100; color: white; width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); pointer-events: none; }
        #mapMakerContainer .map-popup h4 { font-weight: bold; color: #60a5fa; margin-bottom: 4px; }
        #mapMakerContainer .map-popup p { font-size: 14px; margin-bottom: 2px; }

        /* --- Print Styles --- */
        @media print {
            body { background-color: white !important; color: black !important; }
            #app { display: block !important; }
            aside, #projectTypeModal, #campaignSetupModal, #scenarioSetupModal, #mobileMessage, .editable, .no-print, #mapMakerContainer { display: none !important; }
            main { overflow-y: visible !important; height: auto !important; }
            .viewable { display: block !important; }
            .bg-white, .dark\:bg-gray-800, .story-arc-card { box-shadow: none !important; border: 1px solid #ccc !important; background-color: white !important; color: black !important; }
            h2, h3, h4, p, span, div { color: black !important; }
            .prose-style { color: black !important; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 transition-colors duration-300 writer-mode">

    <!-- Initial Project Type Selection Modal -->
    <div id="projectTypeModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-4xl w-full transform transition-all">
            <h2 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-white">What are you creating?</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Choose a project type to get started.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="showCampaignSetup()" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-purple-500 hover:bg-purple-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Campaign</h3>
                    <p class="text-gray-600 dark:text-gray-400">A multi-session, long-form adventure with story arcs, factions, and deep world-building.</p>
                </button>
                <button onclick="showScenarioSetup()" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-teal-500 hover:bg-teal-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Scenario / One-Shot</h3>
                    <p class="text-gray-600 dark:text-gray-400">A self-contained adventure, ideal for a single session or short series.</p>
                </button>
                <button onclick="showMapMaker()" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-yellow-500 hover:bg-yellow-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Map Maker</h3>
                    <p class="text-gray-600 dark:text-gray-400">Create a custom hex map with terrain, objects, and layers.</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Campaign Setup Modal -->
    <div id="campaignSetupModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-all">
            <h2 class="text-3xl font-bold mb-2 text-center text-gray-800 dark:text-white">Create Your New Campaign</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Define the core identity of your world and story.</p>
            <div class="space-y-4">
                <div>
                    <label for="campaignTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Campaign Title</label>
                    <input type="text" id="campaignTitle" placeholder="The Dragon's Inheritance" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="campaignPitch" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Campaign Pitch</label>
                    <textarea id="campaignPitch" rows="3" placeholder="A one-paragraph elevator pitch for your campaign." class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 prose-style"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="campaignGenre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Genre</label>
                        <select id="campaignGenre" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Heroic Fantasy</option><option>Investigative Horror</option><option>Dystopian Intrigue</option><option>Sci-Fi Opera</option><option>Political Thriller</option><option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="campaignStructure" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Primary Structure</label>
                        <select id="campaignStructure" class="mt-1 block w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>Linear</option><option>Episodic</option><option>Sandbox</option><option>Hybrid</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button onclick="startCampaign()" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all text-lg">Start Building</button>
            </div>
        </div>
    </div>

    <!-- Scenario Setup Modal -->
    <div id="scenarioSetupModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-all">
             <h2 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-white">Create Your Scenario</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Start by choosing a foundational structure.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="startScenario('Linear')" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Linear Adventure</h3>
                    <p class="text-gray-600 dark:text-gray-400">A sequential series of scenes or encounters. Ideal for focused, story-driven one-shots.</p>
                </button>
                <button onclick="startScenario('Sandbox')" class="structure-card text-left p-6 bg-gray-50 dark:bg-gray-700 rounded-lg hover:ring-2 hover:ring-green-500 hover:bg-green-50 dark:hover:bg-gray-600 transition-all">
                    <h3 class="font-bold text-xl mb-2 text-gray-800 dark:text-white">Sandbox Campaign</h3>
                    <p class="text-gray-600 dark:text-gray-400">An open world full of locations, factions, and emergent narratives. Best for player-driven stories.</p>
                </button>
            </div>
            <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                <h3 class="text-xl font-bold mb-2 text-center text-gray-800 dark:text-white">Link to Campaign (Optional)</h3>
                <p class="text-center text-gray-600 dark:text-gray-400 mb-4">Use NPCs, locations, and other data from a master campaign file.</p>
                <button id="linkCampaignBtn" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">Select Campaign File (.json)</button>
                <input type="file" id="linkCampaignInput" class="hidden" accept=".json">
                <p id="linkedCampaignInfo" class="text-center text-sm text-green-500 mt-2"></p>
            </div>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app" class="md:grid md:grid-cols-[280px_1fr] h-screen">
        <!-- Sidebar -->
        <aside class="bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col p-4">
            <div class="mb-4 text-center">
                <h1 class="text-2xl font-bold">RPG SCENARIO GUIDE</h1>
            </div>
            <div class="flex justify-between items-center mb-8 px-2">
                <div class="relative no-print">
                    <button id="fileMenuButton" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    </button>
                    <div id="fileMenu" class="hidden absolute left-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20 border border-gray-200 dark:border-gray-700">
                        <a href="#" id="printPdfButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Print to PDF</a>
                        <a href="#" id="saveLocalButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Save Local (.json)</a>
                        <a href="#" id="loadLocalButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Load Local (.json)</a>
                         <a href="#" id="backToMenuBtn" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 border-t border-gray-200 dark:border-gray-600">Back to Main Menu</a>
                    </div>
                </div>
                <button id="createNewProjectButton" title="Create New Project" class="p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 no-print">
                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 9a.75.75 0 00-1.5 0v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <nav class="flex-grow space-y-2 no-print">
                <h3 class="px-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Add Components</h3>
                <button onclick="addComponent('story_arc')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 6H3"/><path d="M21 12H3"/><path d="M21 18H3"/></svg><span>Story Arc</span></button>
                <button onclick="addComponent('npc')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="4"/><path d="M18 11a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2z"/></svg><span>NPC</span></button>
                <button onclick="addComponent('location')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg><span>Location</span></button>
                <button onclick="addComponent('faction')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Faction</span></button>
                <button onclick="addComponent('encounter')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m13.29 13.29-4.6 4.6a2 2 0 1 0 2.83 2.83l4.6-4.6a2 2 0 0 0 0-2.83l-4.6-4.6a2 2 0 1 0-2.83 2.83z"/><path d="M10.59 10.59 7.76 7.76"/><path d="m16.24 7.76-2.83 2.83"/></svg><span>Encounter</span></button>
                <button onclick="addComponent('item')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 13V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h4"/><path d="M14 22h6a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Z"/></svg><span>Magic Item</span></button>
                <button onclick="addComponent('clue')" class="sidebar-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><svg class="sidebar-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><circle cx="11.5" cy="14.5" r="2.5"/><path d="M13.25 16.25 15 18"/></svg><span>Clue</span></button>
            </nav>
            <div class="mt-auto no-print">
                <div class="flex items-center justify-between p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                    <span class="font-semibold text-sm">Writer Mode</span>
                    <label class="switch"><input type="checkbox" id="modeToggle"><span class="slider"></span></label>
                    <span class="font-semibold text-sm">GM Mode</span>
                </div>
            </div>
        </aside>
        <main class="bg-gray-100 dark:bg-gray-900 overflow-y-auto">
            <div class="p-8">
                <div id="projectHeader" class="mb-8"></div>
                <div id="mainContent" class="space-y-6"></div>
            </div>
        </main>
    </div>

    <!-- Map Maker Container -->
    <div id="mapMakerContainer" class="hidden">
        <!-- This will be populated by the map maker's HTML -->
    </div>

    <!-- Hidden file input for loading -->
    <input type="file" id="loadFileInput" class="hidden" accept=".json">

    <!-- Mobile view message -->
    <div id="mobileMessage" class="md:hidden flex flex-col items-center justify-center h-screen text-center p-4">
        <svg class="w-16 h-16 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-1.2 0-2.4.6-3 1.7A3.5 3.5 0 0 0 6.5 8c0 2.3 2.5 4.5 6 6.5 3.5-2 6-4.2 6-6.5a3.5 3.5 0 0 0-2.5-3.3c-.6-1.1-1.8-1.7-3-1.7Z"/><path d="m12 14-4 4h8l-4-4Z"/></svg>
        <h2 class="text-2xl font-bold mb-2">RPG SCENARIO GUIDE</h2>
        <p>This application is best experienced on a desktop or tablet device for the full creation workflow.</p>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        function showModal(message, onConfirm) {
            const existingModal = document.querySelector('.modal-backdrop');
            if(existingModal) existingModal.remove();

            const modalBackdrop = document.createElement('div');
            modalBackdrop.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modalBackdrop.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-white">
                    <p class="mb-6 text-center">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="modalCancel" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 transition">Cancel</button>
                        ${onConfirm ? `<button id="modalConfirm" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition">Confirm</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modalBackdrop);
            modalBackdrop.querySelector('#modalCancel').onclick = () => document.body.removeChild(modalBackdrop);
            if (onConfirm) {
                modalBackdrop.querySelector('#modalConfirm').onclick = () => {
                    onConfirm();
                    document.body.removeChild(modalBackdrop);
                };
            }
        }

        // --- SCENARIO GUIDE SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let project = {
                type: null, // 'campaign' or 'scenario'
                title: 'Untitled Project',
                pitch: '',
                genre: '',
                structure: null,
                components: []
            };
            let masterCampaignComponents = [];
            let nextId = 1;

            // --- DOM ELEMENTS ---
            const projectTypeModal = document.getElementById('projectTypeModal');
            const campaignSetupModal = document.getElementById('campaignSetupModal');
            const scenarioSetupModal = document.getElementById('scenarioSetupModal');
            const mainApp = document.getElementById('app');
            const mainContent = document.getElementById('mainContent');
            const projectHeader = document.getElementById('projectHeader');
            const modeToggle = document.getElementById('modeToggle');
            const body = document.body;
            const fileMenuButton = document.getElementById('fileMenuButton');
            const fileMenu = document.getElementById('fileMenu');
            const printPdfButton = document.getElementById('printPdfButton');
            const saveLocalButton = document.getElementById('saveLocalButton');
            const loadLocalButton = document.getElementById('loadLocalButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const createNewProjectButton = document.getElementById('createNewProjectButton');
            const mapMakerContainer = document.getElementById('mapMakerContainer');
            const backToMenuBtn = document.getElementById('backToMenuBtn');
            const linkCampaignBtn = document.getElementById('linkCampaignBtn');
            const linkCampaignInput = document.getElementById('linkCampaignInput');
            const linkedCampaignInfo = document.getElementById('linkedCampaignInfo');


            // --- FUNCTIONS ---
            window.showCampaignSetup = () => {
                projectTypeModal.classList.add('hidden');
                campaignSetupModal.classList.remove('hidden');
                campaignSetupModal.classList.add('flex');
            };

            window.showScenarioSetup = () => {
                projectTypeModal.classList.add('hidden');
                scenarioSetupModal.classList.remove('hidden');
                scenarioSetupModal.classList.add('flex');
            };
            
            window.showMapMaker = () => {
                hideAllModals();
                mapMakerContainer.classList.remove('hidden');
                if (!mapMakerContainer.dataset.initialized) {
                    initializeMapMaker(project, masterCampaignComponents); // Pass the current project to the map maker
                    mapMakerContainer.dataset.initialized = 'true';
                }
            };

            const hideAllModals = () => {
                projectTypeModal.classList.add('hidden');
                projectTypeModal.classList.remove('flex');
                campaignSetupModal.classList.add('hidden');
                campaignSetupModal.classList.remove('flex');
                scenarioSetupModal.classList.add('hidden');
                scenarioSetupModal.classList.remove('flex');
                mainApp.classList.add('hidden');
                mainApp.classList.remove('md:grid');
                mapMakerContainer.classList.add('hidden');
            };
            
            const showMainMenu = () => {
                 hideAllModals();
                 project = { type: null, title: 'Untitled Project', pitch: '', genre: '', structure: null, components: [] };
                 masterCampaignComponents = [];
                 render();
                 mainApp.classList.remove('hidden');
                 mainApp.classList.add('md:grid');
            }

            window.startCampaign = () => {
                project.type = 'campaign';
                project.title = document.getElementById('campaignTitle').value || 'Untitled Campaign';
                project.pitch = document.getElementById('campaignPitch').value;
                project.genre = document.getElementById('campaignGenre').value;
                project.structure = document.getElementById('campaignStructure').value;
                masterCampaignComponents = [];
                hideAllModals();
                mainApp.classList.remove('hidden');
                mainApp.classList.add('md:grid');
                renderProjectHeader();
                render();
            };
            
            window.startScenario = (structureType) => {
                project.type = 'scenario';
                project.title = 'Untitled Scenario';
                project.structure = structureType;
                // masterCampaignComponents is already loaded at this point if a file was selected
                hideAllModals();
                mainApp.classList.remove('hidden');
                mainApp.classList.add('md:grid');
                renderProjectHeader();
                render();
            };

            // --- EVENT LISTENERS ---
            modeToggle.addEventListener('change', (e) => {
                body.classList.toggle('gm-mode', e.target.checked);
                body.classList.toggle('writer-mode', !e.target.checked);
                render();
            });

            createNewProjectButton.addEventListener('click', () => {
                hideAllModals();
                linkedCampaignInfo.textContent = '';
                linkCampaignInput.value = '';
                projectTypeModal.classList.remove('hidden');
                projectTypeModal.classList.add('flex');
            });
            
            backToMenuBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showMainMenu();
            });

            fileMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                if (!fileMenu.classList.contains('hidden')) {
                    fileMenu.classList.add('hidden');
                }
            });

            printPdfButton.addEventListener('click', (e) => {
                e.preventDefault();
                window.print();
                fileMenu.classList.add('hidden');
            });

            saveLocalButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (!project.type) {
                    showModal("Please create or load a project before saving.");
                    return;
                }
                const dataStr = JSON.stringify(project, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const safeTitle = project.title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeTitle || 'rpg-scenario-project'}.json`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                fileMenu.classList.add('hidden');
            });

            loadLocalButton.addEventListener('click', (e) => {
                e.preventDefault();
                loadFileInput.click();
                fileMenu.classList.add('hidden');
            });

            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (loadedData && typeof loadedData === 'object' && loadedData.hasOwnProperty('components')) {
                            project = loadedData;
                            masterCampaignComponents = []; // Reset linked campaign on new load
                            nextId = Math.max(0, ...project.components.map(c => c.id)) + 1;
                            hideAllModals();
                            mainApp.classList.remove('hidden');
                            mainApp.classList.add('md:grid');
                            renderProjectHeader();
                            render();
                        } else {
                            showModal('Invalid project file format.');
                        }
                    } catch (error) {
                        console.error("Error parsing file:", error);
                        showModal('Failed to load file. It might be corrupted or not a valid JSON file.');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            linkCampaignBtn.addEventListener('click', () => linkCampaignInput.click());

            linkCampaignInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (loadedData && loadedData.type === 'campaign' && loadedData.hasOwnProperty('components')) {
                            masterCampaignComponents = loadedData.components;
                            linkedCampaignInfo.textContent = `Linked to: ${loadedData.title}`;
                            showModal(`Successfully linked to campaign "${loadedData.title}".`);
                        } else {
                            showModal('Invalid campaign file. Please select a valid campaign JSON file.');
                            masterCampaignComponents = [];
                            linkedCampaignInfo.textContent = '';
                        }
                    } catch (error) {
                         showModal('Failed to load campaign file. It might be corrupted.');
                         masterCampaignComponents = [];
                         linkedCampaignInfo.textContent = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- COMPONENT LOGIC ---
            window.addComponent = (type) => {
                if (!project.type) {
                    showModal("Please create a new project first by clicking the '+' button.");
                    return;
                }
                const newComponent = { id: nextId++, type: type, data: getTemplateForType(type) };
                project.components.push(newComponent);
                render();
            };
            
            window.deleteComponent = (id) => {
                project.components = project.components.filter(c => c.id !== id);
                render();
            };

            window.saveComponent = (id) => {
                const component = project.components.find(c => c.id === id);
                if (!component) return;
                const form = document.querySelector(`[data-id='${id}']`);
                const inputs = form.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.dataset.key) component.data[input.dataset.key] = input.value;
                });
                render();
            };

            const getTemplateForType = (type) => {
                switch (type) {
                    case 'story_arc': return { name: 'New Story Arc', summary: '' };
                    case 'npc': return { name: 'New NPC', goal: '', description: '', quirk: '' };
                    case 'location': return { name: 'New Location', description: '', atmosphere: '', key_figures: '' };
                    case 'faction': return { name: 'New Faction', goals: '', key_members: '', relationships: '' };
                    case 'encounter': return { name: 'New Encounter', type: 'Combat', description: '', setup: '', resolution: '' };
                    case 'item': return { name: 'Magic Item', description: '', properties: '' };
                    case 'clue': return { name: 'A Mysterious Clue', information: '', location_found: '' };
                    default: return { name: 'New Component' };
                }
            };
            
            // --- RENDER FUNCTIONS ---
            const renderProjectHeader = () => {
                if (!project.type) {
                    projectHeader.innerHTML = '';
                    return;
                }
                let headerHTML = `<h2 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">${project.title}</h2>`;
                if (project.type === 'campaign' && project.pitch) {
                    headerHTML += `<p class="prose-style text-lg text-gray-600 dark:text-gray-400 italic">${project.pitch}</p>`;
                } else if (project.type === 'scenario') {
                    headerHTML += `<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${project.structure === 'Linear' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">${project.structure} Structure</span>`;
                }
                projectHeader.innerHTML = headerHTML;
            };

            const render = () => {
                const sidebarButtons = document.querySelectorAll('.sidebar-btn');
                const isProjectActive = !!project.type;
                
                sidebarButtons.forEach(btn => btn.disabled = !isProjectActive);
                
                mainContent.innerHTML = '';
                if (!isProjectActive) {
                    projectHeader.innerHTML = '';
                    mainContent.innerHTML = `
                        <div class="text-center py-16 px-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No Project Loaded</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Click the '+' button in the sidebar to create or load a project.</p>
                        </div>`;
                } else if (project.components.length === 0) {
                    mainContent.innerHTML = `
                        <div class="text-center py-16 px-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No components yet</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding a component from the sidebar.</p>
                        </div>`;
                } else {
                    project.components.forEach(component => {
                        const componentElement = document.createElement('div');
                        if (component.type === 'story_arc') {
                            componentElement.className = 'story-arc-card';
                        } else {
                            componentElement.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700';
                        }
                        componentElement.setAttribute('data-id', component.id);
                        componentElement.innerHTML = `
                            ${renderComponentHeader(component)}
                            <div class="mt-4">
                                ${renderWriterView(component)}
                                ${renderGmView(component)}
                            </div>
                        `;
                        mainContent.appendChild(componentElement);
                    });
                }
            };
            
            const renderComponentHeader = (component) => {
                const typeName = component.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const textColor = component.type === 'story_arc' ? 'text-white' : 'text-gray-800 dark:text-white';
                return `
                    <div class="flex justify-between items-center ${component.type !== 'story_arc' ? 'pb-3 border-b border-gray-200 dark:border-gray-700' : ''}">
                        <div>
                            <h3 class="text-2xl font-bold ${textColor}">${component.data.name || 'Untitled'}</h3>
                            <span class="text-xs font-semibold uppercase ${component.type === 'story_arc' ? 'text-blue-300' : 'text-gray-500 dark:text-gray-400'}">${typeName}</span>
                        </div>
                        <div class="editable no-print">
                             <button onclick="saveComponent(${component.id})" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Save</button>
                             <button onclick="deleteComponent(${component.id})" class="ml-2 text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Delete</button>
                        </div>
                    </div>
                `;
            };

            const renderWriterView = (component) => {
                let fields = '';
                for (const key in component.data) {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const labelColor = component.type === 'story_arc' ? 'text-gray-300' : 'text-gray-700 dark:text-gray-300';
                    const inputBg = component.type === 'story_arc' ? 'bg-gray-800' : 'bg-gray-50 dark:bg-gray-700';
                    const inputBorder = component.type === 'story_arc' ? 'border-gray-600' : 'border-gray-300 dark:border-gray-600';

                    if (key === 'description' || key === 'properties' || key === 'setup' || key === 'resolution' || key === 'summary' || key === 'goals' || key === 'relationships') {
                        fields += `<div class="mb-4"><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><textarea data-key="${key}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500 prose-style" rows="4">${component.data[key]}</textarea></div>`;
                    } else {
                         fields += `<div class="mb-4"><label class="block text-sm font-medium ${labelColor} mb-1">${label}</label><input type="text" data-key="${key}" value="${component.data[key]}" class="w-full p-2 ${inputBg} border ${inputBorder} rounded-md focus:ring-blue-500 focus:border-blue-500"></div>`;
                    }
                }
                return `<div class="editable space-y-4">${fields}</div>`;
            };

            const renderGmView = (component) => {
                let fields = '';
                 for (const key in component.data) {
                    if(component.data[key]){
                        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                         const labelColor = component.type === 'story_arc' ? 'text-blue-300' : 'text-gray-600 dark:text-gray-400';
                         const textColor = component.type === 'story_arc' ? 'text-gray-200' : 'text-gray-800 dark:text-gray-200';
                        fields += `
                            <div class="mb-3">
                                <h4 class="font-semibold ${labelColor}">${label}</h4>
                                <p class="prose-style ${textColor}">${component.data[key].replace(/\n/g, '<br>')}</p>
                            </div>
                        `;
                    }
                }
                return `<div class="viewable space-y-2">${fields}</div>`;
            };

            // --- MAP MAKER SCRIPT ---
            function initializeMapMaker(scenarioProject, masterComponents) {
                // Populate the map maker container
                mapMakerContainer.innerHTML = `
                <div id="main-container">
                    <div id="canvas-container"><canvas id="mapCanvas"></canvas></div>
                    <div id="panelWrapper">
                        <div id="controlContainer" class="control-container p-6 flex flex-col shadow-lg">
                            <div class="flex justify-between items-center mb-2 flex-shrink-0 relative">
                                <button id="backToScenarioGuideBtn" class="p-2 rounded-md hover:bg-gray-700 mr-2" title="Back to Main Menu">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-100 flex-grow">Map Controls</h2>
                                <div class="flex items-center">
                                    <button id="fileMenuBtnMap" class="p-2 rounded-md hover:bg-gray-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                                    </button>
                                    <button id="collapseBtn" class="p-2 rounded-md hover:bg-gray-700 ml-2" title="Hide Panel">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                                    </button>
                                </div>
                                <div id="fileDropdownMenuMap" class="file-dropdown hidden mt-2 right-10 top-full">
                                    <button id="savePngBtn" class="file-dropdown-item">Save as PNG</button>
                                    <button id="saveJsonBtn" class="file-dropdown-item">Save Map (.json)</button>
                                    <button id="loadJsonBtnMap" class="file-dropdown-item">Load Map (.json)</button>
                                </div>
                                <input type="file" id="loadJsonInputMap" class="hidden" accept=".json">
                            </div>
                            <div class="grid grid-cols-5 gap-4 items-end mb-4 flex-shrink-0">
                                <div class="col-span-3">
                                    <label for="mapNameInput" class="text-xs text-gray-400">Map Name</label>
                                    <input type="text" id="mapNameInput" placeholder="Untitled Map" class="text-lg bg-transparent border-0 border-b-2 border-gray-600 focus:ring-0 focus:border-blue-500 !p-1 !mb-0">
                                </div>
                                <div class="col-span-2">
                                    <label for="mapScaleInput" class="text-xs text-gray-400">Scale (m)</label>
                                    <input type="number" id="mapScaleInput" value="10" min="1" class="!p-1 !mb-0 text-lg">
                                </div>
                            </div>
                            <div class="flex-grow overflow-y-auto pr-2">
                                <!-- Map Maker Controls will be here -->
                                <div class="control-panel mb-6">
                                    <h3 class="!border-b-0">Drawing Tools</h3>
                                    <div class="grid grid-cols-5 gap-2 my-2">
                                        <button id="toolPaintBtn" title="Paint Brush" class="active"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></button>
                                        <button id="toolLineBtn" title="Line"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                                        <button id="toolRectBtn" title="Rectangle"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>
                                        <button id="toolEllipseBtn" title="Ellipse"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg></button>
                                        <button id="toolLinkBtn" title="Link Component"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
                                    </div>
                                    <label for="brushSize">Brush/Object Size: <span id="brushSizeValue">1</span></label>
                                    <input type="range" id="brushSize" min="1" max="10" value="1" class="mb-3">
                                </div>
                                <div class="control-panel mb-6">
                                    <h3 class="!border-b-0">Actions</h3>
                                    <div class="grid grid-cols-2 gap-2 my-2">
                                        <button id="zoomInBtn" title="Zoom In" class="text-2xl">+</button>
                                        <button id="zoomOutBtn" title="Zoom Out" class="text-2xl">-</button>
                                        <button id="eraserBtn" title="Eraser"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg></button>
                                        <button id="resetViewBtn" title="Reset View & Zoom">Center</button>
                                    </div>
                                </div>
                                <div class="control-panel mb-6">
                                    <div id="aiEditorHeader" class="collapsible-header collapsed"><h3> AI Map Editor</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="aiEditorContent" class="collapsible-content hidden">
                                        <label for="aiAlterPrompt">Describe the changes to make:</label>
                                        <textarea id="aiAlterPrompt" placeholder="e.g., Add a road from west to east."></textarea>
                                        <button id="aiAlterMapBtn" data-original-text="Alter Map">Alter Map</button>
                                    </div>
                                </div>
                                <div class="control-panel mb-6">
                                    <div id="terrainHeader" class="collapsible-header collapsed"><h3>Terrain Type</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="terrainContent" class="collapsible-content hidden"><div id="terrainSelector" class="flex flex-col gap-2"></div></div>
                                </div>
                                <div class="control-panel mb-6">
                                    <div id="objectHeader" class="collapsible-header collapsed"><h3>Objects</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="objectContent" class="collapsible-content hidden"><div id="objectSelector" class="flex flex-col gap-2"></div></div>
                                </div>
                                <div id="textToolPanel" class="control-panel mb-6">
                                    <div id="textHeader" class="collapsible-header collapsed"><h3>Text</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="textContent" class="collapsible-content hidden">
                                        <label for="textInput">Text</label><input type="text" id="textInput" value="Label">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label for="fontSizeInput">Size</label><input type="number" id="fontSizeInput" value="20" min="1"></div>
                                            <div><label for="fontColorInput">Color</label><input type="color" id="fontColorInput" value="#FFFFFF"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="control-panel mb-6">
                                    <div id="layerHeader" class="collapsible-header collapsed"><h3>Layers</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="layerContent" class="collapsible-content hidden">
                                        <div id="layerList" class="flex flex-col gap-2 mb-4"></div>
                                        <div class="grid grid-cols-2 gap-2"><button id="addLayerBtn">Add Layer</button><button id="deleteLayerBtn">Delete Layer</button></div>
                                    </div>
                                </div>
                                <div class="control-panel">
                                    <div id="mapGenerationHeader" class="collapsible-header collapsed"><h3>Manual Generation</h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                                    <div id="mapGenerationContent" class="collapsible-content hidden">
                                        <label for="mapShape">Shape</label><select id="mapShape"><option value="rectangle">Rectangle</option><option value="parallelogram">Parallelogram</option><option value="circle">Circle</option></select>
                                        <div id="dimensionInputs">
                                            <div class="grid grid-cols-2 gap-2">
                                                <div><label for="mapWidth">Width</label><input type="number" id="mapWidth" value="50" min="1"></div>
                                                <div><label for="mapHeight">Height</label><input type="number" id="mapHeight" value="50" min="1"></div>
                                            </div>
                                            <div class="hidden"><label for="mapRadius">Radius</label><input type="number" id="mapRadius" value="15" min="1"></div>
                                        </div>
                                        <button id="generateMapBtn">Generate New Map</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="collapsedBar" class="collapsed-bar hidden">MAP OPTIONS</div>
                </div>
                `;
                
                // Now run the map maker's logic with the newly created DOM elements
                runMapMakerLogic(showMainMenu, scenarioProject, masterComponents);
            }

            // Initial Load
            showMainMenu();
        });

        function runMapMakerLogic(showMainMenu, scenarioProject, masterCampaignComponents) {
            const canvas = document.getElementById('mapCanvas');
            if (!canvas) {
                console.error("Map canvas not found! Initialization failed.");
                return;
            }
            const ctx = canvas.getContext('2d');
            const baseHexSize = 30;
            let mapGrid = {}, mapName = 'Untitled Map', mapScale = 10, layers = [], activeLayerIndex = 0, currentTool = 'paint', brushSize = 1, selectedTerrain = 'grass', selectedObjectKey = 'Fantasy.Outside.tree', view = { zoom: 1, offsetX: 0, offsetY: 0 }, isPanning = false, panStart = { x: 0, y: 0 }, isDrawingShape = false, isPainting = false, shapeStartHex = null;
            let previewCanvas = document.createElement('canvas');
            let previewCtx = previewCanvas.getContext('2d');

            const backToScenarioGuideBtn = document.getElementById('backToScenarioGuideBtn');
            const controlContainer = document.getElementById('controlContainer');
            const collapseBtn = document.getElementById('collapseBtn');
            const collapsedBar = document.getElementById('collapsedBar');
            const mapNameInput = document.getElementById('mapNameInput');
            const mapScaleInput = document.getElementById('mapScaleInput');
            const brushSizeSlider = document.getElementById('brushSize');
            const brushSizeValue = document.getElementById('brushSizeValue');
            const terrainSelector = document.getElementById('terrainSelector');
            const objectSelector = document.getElementById('objectSelector');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const resetViewBtn = document.getElementById('resetViewBtn');
            const eraserBtn = document.getElementById('eraserBtn');
            const mapShapeSelect = document.getElementById('mapShape');
            const mapWidthInput = document.getElementById('mapWidth');
            const mapHeightInput = document.getElementById('mapHeight');
            const mapRadiusInput = document.getElementById('mapRadius');
            const dimensionInputs = document.getElementById('dimensionInputs');
            const generateMapBtn = document.getElementById('generateMapBtn');
            const layerList = document.getElementById('layerList');
            const addLayerBtn = document.getElementById('addLayerBtn');
            const deleteLayerBtn = document.getElementById('deleteLayerBtn');
            const textToolPanel = document.getElementById('textToolPanel');
            const textHeader = document.getElementById('textHeader');
            const textInput = document.getElementById('textInput');
            const fontSizeInput = document.getElementById('fontSizeInput');
            const fontColorInput = document.getElementById('fontColorInput');
            const fileMenuBtn = document.getElementById('fileMenuBtnMap');
            const fileDropdownMenu = document.getElementById('fileDropdownMenuMap');
            const savePngBtn = document.getElementById('savePngBtn');
            const saveJsonBtn = document.getElementById('saveJsonBtn');
            const loadJsonBtn = document.getElementById('loadJsonBtnMap');
            const loadJsonInput = document.getElementById('loadJsonInputMap');
            const toolPaintBtn = document.getElementById('toolPaintBtn');
            const toolLineBtn = document.getElementById('toolLineBtn');
            const toolRectBtn = document.getElementById('toolRectBtn');
            const toolEllipseBtn = document.getElementById('toolEllipseBtn');
            const toolLinkBtn = document.getElementById('toolLinkBtn');
            const aiAlterPrompt = document.getElementById('aiAlterPrompt');
            const aiAlterMapBtn = document.getElementById('aiAlterMapBtn');
            
            const accordionHeaders = Array.from(document.querySelectorAll('#mapMakerContainer .collapsible-header'));
            const accordionContents = Array.from(document.querySelectorAll('#mapMakerContainer .collapsible-content'));

            const terrains = { grass: { color: '#86c440', name: 'Grass' }, plains: { color: '#a6d15a', name: 'Plains'}, forest: { color: '#4a8232', name: 'Forest' }, hills: { color: '#a08b6b', name: 'Hills'}, mountain: {color: '#6f6f6f', name: 'Mountain'}, crags: {color: '#5a5a5a', name: 'Crags'}, water: { color: '#4c92c8', name: 'Water' }, swamp: { color: '#4d6642', name: 'Swamp'}, sand: { color: '#f0d9a0', name: 'Sand' }, dirt: { color: '#a07040', name: 'Dirt' }, tundra: { color: '#cdd3d6', name: 'Tundra' }, snow: { color: '#ffffff', name: 'Snow'}, lava: { color: '#e25822', name: 'Lava'}, road: { color: '#b0a89f', name: 'Road'} };
            const objectCategories = { "Fantasy": { "Outside": { tree: { symbol: '', name: 'Tree' }, rock: { symbol: '', name: 'Rock' }, stump: { symbol: '', name: 'Stump' }, flower: { symbol: '', name: 'Flower' }, mushroom: { symbol: '', name: 'Mushroom' } }, "City": { house: { symbol: '', name: 'House' }, shop: { symbol: '', name: 'Shop' }, fountain: { symbol: '', name: 'Fountain' }, statue: { symbol: '', name: 'Statue' }, wall: { symbol: '', name: 'Wall' } }, "Castle/Fort": { tower: { symbol: '', name: 'Tower'}, wall_stone: { symbol: '', name: 'Stone Wall' }, keep: { symbol: '', name: 'Keep' }, barracks: { symbol: '', name: 'Barracks' } }, "Dungeon": { cave: {symbol: '', name: 'Cave'}, monster: {symbol: '', name: 'Monster'}, treasure: { symbol: '', name: 'Treasure' }, trap: { symbol: '', name: 'Trap' }, stairs: { symbol: '', name: 'Stairs' }, door: { symbol: '', name: 'Door' } }, "Farm & Bar": { farmhouse: { symbol: '', name: 'Farmhouse'}, barn: { symbol: '', name: 'Barn'}, well: { symbol: '', name: 'Well' }, crops: { symbol: '', name: 'Crops' }, inn: { symbol: '', name: 'Inn/Bar'} } }, "Sci-Fi": { "Outside": { alien_tree: { symbol: '', name: 'Alien Flora' }, crystal: { symbol: '', name: 'Crystal' }, crater: { symbol: '', name: 'Crater' }, rover: { symbol: '', name: 'Rover' } }, "Base/City": { habitat: { symbol: '', name: 'Habitat Dome' }, lab: { symbol: '', name: 'Lab' }, power_plant: { symbol: '', name: 'Power Plant' }, comm_tower: { symbol: '', name: 'Comm Tower'}, landing_pad: { symbol: '', name: 'Landing Pad'} }, "Interior": { console: { symbol: '', name: 'Console' }, stasis_pod: { symbol: '', name: 'Stasis Pod'}, robot: { symbol: '', name: 'Robot' }, alien: { symbol: '', name: 'Alien' }, airlock: { symbol: '', name: 'Airlock'} } } };

            function initialize() { resizeCanvas(); togglePanel(true); generateNewMap('rectangle', 50, 50, 15, 'Untitled Map'); populateSelectors(); addEventListeners(); }
            function togglePanel(isCollapsed) { controlContainer.classList.toggle('open', !isCollapsed); collapsedBar.classList.toggle('hidden', !isCollapsed); }
            function resizeCanvas() { if(!canvas.parentElement) return; canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; previewCanvas.width = canvas.width; previewCanvas.height = canvas.height; centerView(); }
            function generateNewMap(shape, width, height, radius, name = "Untitled Map") { mapGrid = {}; mapName = name; mapScale = 10; mapNameInput.value = mapName; mapScaleInput.value = mapScale; const w = parseInt(width), h = parseInt(height), r_rad = parseInt(radius); switch(shape) { case 'rectangle': for (let row = 0; row < h; row++) { const r_offset = Math.floor(row / 2); for (let col = -r_offset; col < w - r_offset; col++) mapGrid[`${col},${row}`] = true; } break; case 'parallelogram': for (let q = 0; q < w; q++) for (let r = 0; r < h; r++) mapGrid[`${q},${r}`] = true; break; case 'circle': for (let q = -r_rad; q <= r_rad; q++) for (let r = -r_rad; r <= r_rad; r++) if (axialDistance({q:0, r:0}, {q, r}) <= r_rad) mapGrid[`${q},${r}`] = true; break; } layers = []; activeLayerIndex = 0; addNewLayer("Ground"); addNewLayer("Objects"); centerView(); }
            function centerView() { if (Object.keys(mapGrid).length === 0) return; const {mapPixelWidth, mapPixelHeight, mapCenterX, mapCenterY} = getMapPixelBounds(); if(mapPixelWidth === 0 || mapPixelHeight === 0) return; view.zoom = Math.min(canvas.width / mapPixelWidth, canvas.height / mapPixelHeight) * 0.9; view.zoom = Math.max(0.1, Math.min(5, view.zoom)); view.offsetX = (canvas.width / 2) - (mapCenterX * view.zoom); view.offsetY = (canvas.height / 2) - (mapCenterY * view.zoom); drawGrid(); }
            function drawGrid(offscreenCtx = null, bounds = null) { const targetCtx = offscreenCtx || ctx; if (!offscreenCtx) requestAnimationFrame(() => drawFrame(targetCtx, bounds)); else drawFrame(targetCtx, bounds); }
            function drawFrame(targetCtx, bounds) { targetCtx.save(); if (bounds) { targetCtx.clearRect(0, 0, bounds.width, bounds.height); targetCtx.translate(-bounds.minPxX, -bounds.minPxY); } else { targetCtx.clearRect(0, 0, canvas.width, canvas.height); targetCtx.translate(view.offsetX, view.offsetY); targetCtx.scale(view.zoom, view.zoom); } for (const key in mapGrid) { const [q, r] = key.split(',').map(Number); const { x, y } = hexToPixel(q, r); drawHexOutline(targetCtx, x, y, '#111827'); } layers.forEach(layer => { if (!layer.visible) return; for (const key in layer.data) { const [q, r] = key.split(',').map(Number); const { x, y } = hexToPixel(q, r); const hexData = layer.data[key]; if (hexData.terrain) drawHex(targetCtx, x, y, terrains[hexData.terrain].color); if (hexData.objectKey) { const [mainCat, subCat, objKey] = hexData.objectKey.split('.'); const object = objectCategories[mainCat][subCat][objKey]; drawObject(targetCtx, x, y, object.symbol, hexData.size); } if(hexData.linkedComponentId) { drawObject(targetCtx, x, y, '', 1.2); } if (hexData.text) drawText(targetCtx, x, y, hexData.text, hexData.textSize, hexData.textColor); } }); targetCtx.restore(); if(isDrawingShape && targetCtx === ctx) ctx.drawImage(previewCanvas, 0, 0); }
            function drawHex(targetCtx, x, y, fillStyle) { targetCtx.beginPath(); for (let i = 0; i < 6; i++) { const angle = Math.PI / 180 * (60 * i + 30); targetCtx.lineTo(x + baseHexSize * Math.cos(angle), y + baseHexSize * Math.sin(angle)); } targetCtx.closePath(); targetCtx.fillStyle = fillStyle; targetCtx.fill(); }
            function drawHexOutline(targetCtx, x, y, strokeStyle) { targetCtx.beginPath(); for (let i = 0; i < 6; i++) { const angle = Math.PI / 180 * (60 * i + 30); targetCtx.lineTo(x + baseHexSize * Math.cos(angle), y + baseHexSize * Math.sin(angle)); } targetCtx.closePath(); targetCtx.strokeStyle = strokeStyle; targetCtx.lineWidth = 1.5 / (targetCtx === ctx ? view.zoom : 1); targetCtx.stroke(); }
            function drawObject(targetCtx, x, y, symbol, size = 1) { targetCtx.font = `${baseHexSize * 1.2 * size}px Arial`; targetCtx.textAlign = 'center'; targetCtx.textBaseline = 'middle'; targetCtx.fillText(symbol, x, y); }
            function drawText(targetCtx, x, y, text, size, color) { targetCtx.font = `${size}px Inter`; targetCtx.fillStyle = color; targetCtx.textAlign = 'center'; targetCtx.textBaseline = 'middle'; targetCtx.fillText(text, x, y); }
            function getMapPixelBounds() { let minPxX = Infinity, maxPxX = -Infinity, minPxY = Infinity, maxPxY = -Infinity; const hexVisualWidth = baseHexSize * Math.sqrt(3); const hexVisualHeight = baseHexSize * 2; if (Object.keys(mapGrid).length === 0) return { minPxX: 0, maxPxX: 0, minPxY: 0, maxPxY: 0, mapPixelWidth: 0, mapPixelHeight: 0, mapCenterX: 0, mapCenterY: 0}; for (const key in mapGrid) { const [q, r] = key.split(',').map(Number); const { x, y } = hexToPixel(q, r); minPxX = Math.min(minPxX, x - hexVisualWidth / 2); maxPxX = Math.max(maxPxX, x + hexVisualWidth / 2); minPxY = Math.min(minPxY, y - hexVisualHeight / 2); maxPxY = Math.max(maxPxY, y + hexVisualHeight / 2); } const mapPixelWidth = maxPxX - minPxX, mapPixelHeight = maxPxY - minPxY, mapCenterX = minPxX + mapPixelWidth / 2, mapCenterY = minPxY + mapPixelHeight / 2; return {minPxX, maxPxX, minPxY, maxPxY, mapPixelWidth, mapPixelHeight, mapCenterX, mapCenterY}; }
            function hexToPixel(q, r) { const x = baseHexSize * (Math.sqrt(3) * q + Math.sqrt(3) / 2 * r); const y = baseHexSize * (3 / 2 * r); return { x, y }; }
            function pixelToHex(x, y) { const worldX = (x - view.offsetX) / view.zoom; const worldY = (y - view.offsetY) / view.zoom; const q_frac = (Math.sqrt(3) / 3 * worldX - 1 / 3 * worldY) / baseHexSize; const r_frac = (2 / 3 * worldY) / baseHexSize; return axialRound(q_frac, r_frac); }
            function axialRound(q_frac, r_frac) { const s_frac = -q_frac - r_frac; let q = Math.round(q_frac), r = Math.round(r_frac), s = Math.round(s_frac); const q_diff = Math.abs(q - q_frac), r_diff = Math.abs(r - r_frac), s_diff = Math.abs(s - s_frac); if (q_diff > r_diff && q_diff > s_diff) q = -r - s; else if (r_diff > s_diff) r = -q - s; return { q, r }; }
            function applyTool(e, endHex) { if (!layers.length) return; const activeLayer = layers[activeLayerIndex]; const affectedHexes = getHexesForTool(e, endHex); affectedHexes.forEach(hex => { const key = `${hex.q},${hex.r}`; if (mapGrid[key]) { if (!activeLayer.data[key]) activeLayer.data[key] = {}; if (['paint', 'line', 'rectangle', 'ellipse'].includes(currentTool)) activeLayer.data[key] = { terrain: selectedTerrain }; else if (currentTool === 'place') { if (hex.q === affectedHexes[0].q && hex.r === affectedHexes[0].r) activeLayer.data[key] = { objectKey: selectedObjectKey, size: brushSize }; } else if (currentTool === 'text') { if (hex.q === affectedHexes[0].q && hex.r === affectedHexes[0].r) activeLayer.data[key] = { text: textInput.value, textSize: fontSizeInput.value, textColor: fontColorInput.value }; } else if (currentTool === 'eraser' && activeLayer.data[key]) delete activeLayer.data[key]; } }); drawGrid(); }
            function getHexesForTool(e, endHex = null) { const rect = canvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; const centerHex = endHex || pixelToHex(mouseX, mouseY); if (['paint', 'eraser', 'place', 'link'].includes(currentTool)) return getHexesInBrush(centerHex); if (currentTool === 'line') return getHexesForLine(shapeStartHex, centerHex); if (currentTool === 'rectangle') return getHexesForRectangle(shapeStartHex, centerHex); if (currentTool === 'ellipse') return getHexesForEllipse(shapeStartHex, centerHex); if (currentTool === 'text') return [centerHex]; return []; }
            function getHexesInBrush(centerHex) { const results = []; const range = currentTool === 'link' ? 1 : brushSize - 1; for (let q = -range; q <= range; q++) for (let r = Math.max(-range, -q - range); r <= Math.min(range, -q + range); r++) results.push({ q: centerHex.q + q, r: centerHex.r + r }); return results; }
            function cubeLerp(a, b, t) { return { q: a.q * (1 - t) + b.q * t, r: a.r * (1 - t) + b.r * t }; }
            function getHexesForLine(start, end) { if(!start || !end) return []; const n = axialDistance(start, end); const results = []; for (let i = 0; i <= n; i++) { const cubeCoords = cubeLerp(start, end, (1.0 / n) * i); results.push(axialRound(cubeCoords.q, cubeCoords.r)); } return results; }
            function getHexesForRectangle(start, end) { if(!start || !end) return []; const results = []; const q_min = Math.min(start.q, end.q), q_max = Math.max(start.q, end.q), r_min = Math.min(start.r, end.r), r_max = Math.max(start.r, end.r); for (let q = q_min; q <= q_max; q++) for (let r = r_min; r <= r_max; r++) results.push({ q, r }); return results; }
            function getHexesForEllipse(start, end) { if(!start || !end) return []; const results = []; const centerQ = (start.q + end.q) / 2, centerR = (start.r + end.r) / 2, radiusQ = Math.abs(start.q - end.q) / 2, radiusR = Math.abs(start.r - end.r) / 2; const q_min = Math.floor(centerQ - radiusQ), q_max = Math.ceil(centerQ + radiusQ), r_min = Math.floor(centerR - radiusR), r_max = Math.ceil(centerR + radiusR); for (let q = q_min; q <= q_max; q++) for (let r = r_min; r <= r_max; r++) { if (radiusQ === 0 || radiusR === 0) continue; const dq = (q - centerQ) / radiusQ, dr = (r - centerR) / radiusR; if( (dq * dq) + (dr * dr) <= 1) results.push({ q, r }); } return results; }
            function axialDistance(hexA, hexB) { return (Math.abs(hexA.q - hexB.q) + Math.abs(hexA.q + hexA.r - hexB.q - hexB.r) + Math.abs(hexA.r - hexB.r)) / 2; }
            function renderLayers() { layerList.innerHTML = ''; layers.forEach((layer, index) => { const item = document.createElement('div'); item.className = 'layer-item'; item.classList.toggle('active', index === activeLayerIndex); item.dataset.index = index; const label = document.createElement('div'); label.className = 'layer-label'; label.textContent = layer.name; const controls = document.createElement('div'); controls.className = 'layer-controls'; const visBtn = document.createElement('button'); visBtn.innerHTML = layer.visible ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`; visBtn.title = "Toggle Visibility"; visBtn.onclick = (e) => { e.stopPropagation(); toggleLayerVisibility(index); }; const upBtn = document.createElement('button'); upBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`; upBtn.title = "Move Up"; upBtn.onclick = (e) => { e.stopPropagation(); moveLayer(index, -1); }; const downBtn = document.createElement('button'); downBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`; downBtn.title = "Move Down"; downBtn.onclick = (e) => { e.stopPropagation(); moveLayer(index, 1); }; item.onclick = () => { activeLayerIndex = index; renderLayers(); }; controls.appendChild(visBtn); controls.appendChild(upBtn); controls.appendChild(downBtn); item.appendChild(label); item.appendChild(controls); layerList.appendChild(item); }); }
            function addNewLayer(name = 'New Layer') { const newName = name === 'New Layer' ? `${name} ${layers.length + 1}` : name; layers.push({ name: newName, visible: true, data: {} }); activeLayerIndex = layers.length - 1; renderLayers(); }
            function deleteActiveLayer() { if (layers.length <= 1) { showModal("You cannot delete the last layer."); return; } layers.splice(activeLayerIndex, 1); if (activeLayerIndex >= layers.length) activeLayerIndex = layers.length - 1; renderLayers(); drawGrid(); }
            function moveLayer(index, direction) { if ((index === 0 && direction === -1) || (index === layers.length - 1 && direction === 1)) return; const newIndex = index + direction; [layers[index], layers[newIndex]] = [layers[newIndex], layers[index]]; activeLayerIndex = newIndex; renderLayers(); drawGrid(); }
            function toggleLayerVisibility(index) { layers[index].visible = !layers[index].visible; renderLayers(); drawGrid(); }
            function getSafeFilename(name) { return name.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'untitled-map'; }
            function saveAsPNG() { if (mapName.trim() === '' || mapName.toLowerCase().includes('untitled')) { showModal("Please enter a unique name for your map before saving."); return; } const { mapPixelWidth, mapPixelHeight, minPxX, minPxY } = getMapPixelBounds(); const offscreenCanvas = document.createElement('canvas'); offscreenCanvas.width = mapPixelWidth; offscreenCanvas.height = mapPixelHeight; const offscreenCtx = offscreenCanvas.getContext('2d'); drawGrid(offscreenCtx, { width: mapPixelWidth, height: mapPixelHeight, minPxX, minPxY }); const dataUrl = offscreenCanvas.toDataURL('image/png'); const link = document.createElement('a'); link.download = `${getSafeFilename(mapName)}.png`; link.href = dataUrl; link.click(); }
            function saveAsJSON() { if (mapName.trim() === '' || mapName.toLowerCase().includes('untitled')) { showModal("Please enter a unique name for your map before saving."); return; } const mapData = { name: mapName, scale: mapScale, grid: mapGrid, layers: layers }; const jsonString = JSON.stringify(mapData, null, 2); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = `${getSafeFilename(mapName)}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); }
            function loadFromJSON(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const loadedData = JSON.parse(event.target.result); if (loadedData && loadedData.grid && Array.isArray(loadedData.layers)) { mapGrid = loadedData.grid; layers = loadedData.layers; mapName = loadedData.name || 'Untitled Loaded Map'; mapScale = loadedData.scale || 10; mapNameInput.value = mapName; mapScaleInput.value = mapScale; activeLayerIndex = 0; renderLayers(); centerView(); } else throw new Error("Invalid map file format."); } catch (err) { showModal("Error: Could not load map. File may be corrupt or in the wrong format."); console.error(err); } }; reader.readAsText(file); e.target.value = ''; }
            function addEventListeners() { window.addEventListener('resize', resizeCanvas); canvas.addEventListener('contextmenu', e => e.preventDefault()); canvas.addEventListener('mousedown', e => { if (e.button === 2) { isPanning = true; panStart = { x: e.clientX, y: e.clientY }; canvas.classList.add('panning'); return; } if (e.button === 0) { const rect = canvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top; const clickedHex = pixelToHex(mouseX, mouseY); const key = `${clickedHex.q},${clickedHex.r}`; let linkedComponentId = null; for(const layer of layers) { if(layer.data[key] && layer.data[key].linkedComponentId) { linkedComponentId = layer.data[key].linkedComponentId; break; } } if(linkedComponentId) { showComponentPopup(mouseX, mouseY, linkedComponentId); return; } const isShapeTool = ['line', 'rectangle', 'ellipse'].includes(currentTool); if (isShapeTool) { isDrawingShape = true; shapeStartHex = pixelToHex(e.clientX - canvas.getBoundingClientRect().left, e.clientY - canvas.getBoundingClientRect().top); } else if (currentTool === 'paint' || currentTool === 'eraser') { isPainting = true; applyTool(e); } else if (currentTool === 'link') { showLinkModal(clickedHex); } else applyTool(e); } }); canvas.addEventListener('mousemove', e => { if (isPanning) { view.offsetX += e.clientX - panStart.x; view.offsetY += e.clientY - panStart.y; panStart = { x: e.clientX, y: e.clientY }; drawGrid(); } else if (isDrawingShape) { previewCtx.clearRect(0,0, previewCanvas.width, previewCanvas.height); const currentHex = pixelToHex(e.clientX - canvas.getBoundingClientRect().left, e.clientY - canvas.getBoundingClientRect().top); const shapeHexes = getHexesForTool(e, currentHex); previewCtx.save(); previewCtx.translate(view.offsetX, view.offsetY); previewCtx.scale(view.zoom, view.zoom); shapeHexes.forEach(hex => { const {x, y} = hexToPixel(hex.q, hex.r); drawHex(previewCtx, x, y, 'rgba(100, 150, 255, 0.5)'); }); previewCtx.restore(); drawGrid(); } else if (isPainting) applyTool(e); }); canvas.addEventListener('mouseup', e => { if(isDrawingShape && e.button === 0) { const endHex = pixelToHex(e.clientX - canvas.getBoundingClientRect().left, e.clientY - canvas.getBoundingClientRect().top); applyTool(e, endHex); isDrawingShape = false; shapeStartHex = null; previewCtx.clearRect(0,0, previewCanvas.width, previewCanvas.height); drawGrid(); } isPainting = false; isPanning = false; canvas.classList.remove('panning'); }); canvas.addEventListener('mouseleave', () => { isPanning = false; isPainting = false; isDrawingShape = false; canvas.classList.remove('panning'); const popup = document.getElementById('map-popup'); if(popup) popup.remove(); }); mapNameInput.addEventListener('input', (e) => { mapName = e.target.value; }); mapScaleInput.addEventListener('input', (e) => { mapScale = parseInt(e.target.value) || 10; }); brushSizeSlider.addEventListener('input', e => { brushSize = parseInt(e.target.value); brushSizeValue.textContent = brushSize; }); zoomInBtn.addEventListener('click', () => { view.zoom = Math.min(5, view.zoom * 1.25); drawGrid(); }); zoomOutBtn.addEventListener('click', () => { view.zoom = Math.max(0.1, view.zoom / 1.25); drawGrid(); }); eraserBtn.addEventListener('click', () => { currentTool = 'eraser'; updateActiveSwatches(); }); toolPaintBtn.addEventListener('click', () => { currentTool = 'paint'; updateActiveSwatches(); }); toolLineBtn.addEventListener('click', () => { currentTool = 'line'; updateActiveSwatches(); }); toolRectBtn.addEventListener('click', () => { currentTool = 'rectangle'; updateActiveSwatches(); }); toolEllipseBtn.addEventListener('click', () => { currentTool = 'ellipse'; updateActiveSwatches(); }); toolLinkBtn.addEventListener('click', () => { currentTool = 'link'; updateActiveSwatches(); }); resetViewBtn.addEventListener('click', centerView); addLayerBtn.addEventListener('click', () => addNewLayer()); deleteLayerBtn.addEventListener('click', deleteActiveLayer); textHeader.addEventListener('click', () => { currentTool = 'text'; updateActiveSwatches(); }); mapShapeSelect.addEventListener('change', () => { const isCircle = mapShapeSelect.value === 'circle'; dimensionInputs.children[0].classList.toggle('hidden', isCircle); dimensionInputs.children[1].classList.toggle('hidden', !isCircle); }); generateMapBtn.addEventListener('click', () => { showModal("Generate a new map? This will delete all layers and current work.", () => { generateNewMap(mapShapeSelect.value, mapWidthInput.value, mapHeightInput.value, mapRadiusInput.value, 'Untitled Map'); }); }); fileMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); fileDropdownMenu.classList.toggle('hidden'); }); window.addEventListener('click', (e) => { if (!fileMenuBtn.contains(e.target) && !fileDropdownMenu.contains(e.target)) fileDropdownMenu.classList.add('hidden'); }); savePngBtn.addEventListener('click', saveAsPNG); saveJsonBtn.addEventListener('click', saveAsJSON); loadJsonBtn.addEventListener('click', () => loadJsonInput.click()); loadJsonInput.addEventListener('change', loadFromJSON); accordionHeaders.forEach((header, index) => { header.addEventListener('click', () => { const isCurrentlyOpen = !accordionContents[index].classList.contains('hidden'); accordionContents.forEach(content => content.classList.add('hidden')); accordionHeaders.forEach(h => h.classList.add('collapsed')); if (!isCurrentlyOpen) { accordionContents[index].classList.remove('hidden'); header.classList.remove('collapsed'); } }); }); collapseBtn.addEventListener('click', () => togglePanel(true)); collapsedBar.addEventListener('click', () => togglePanel(false)); aiAlterMapBtn.addEventListener('click', handleAiMapAlteration); backToScenarioGuideBtn.addEventListener('click', showMainMenu); }
            async function handleAiMapAlteration() { const promptText = aiAlterPrompt.value; if (!promptText) { showModal("Please describe the changes you want to make."); return; } setButtonLoading(aiAlterMapBtn, true); const groundLayer = layers.find(l => l.name === 'Ground') || layers[0]; let minQ = Infinity, maxQ = -Infinity, minR = Infinity, maxR = -Infinity; Object.keys(mapGrid).forEach(key => { const [q, r] = key.split(',').map(Number); minQ = Math.min(minQ, q); maxQ = Math.max(maxQ, q); minR = Math.min(minR, r); maxR = Math.max(maxR, r); }); const terrainList = Object.keys(terrains).join(', '); const fullPrompt = `You are an expert cartographer...`; const payload = { contents: [{ role: "user", parts: [{ text: fullPrompt }] }] }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.text(); console.error("API Error Body:", errorBody); throw new Error(`API request failed with status ${response.status}`); } const result = await response.json(); if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) { const rawText = result.candidates[0].content.parts[0].text; const cleanedText = rawText.replace(/```json|```/g, '').trim(); const changes = JSON.parse(cleanedText); changes.forEach(item => { const key = `${item.q},${item.r}`; if(mapGrid[key] && terrains[item.terrain]) { if (!groundLayer.data[key]) groundLayer.data[key] = {}; groundLayer.data[key].terrain = item.terrain; } }); drawGrid(); } else throw new Error("Invalid response structure from API."); } catch (error) { console.error("AI Map Alteration Error:", error); showModal("Sorry, there was an error altering the map. Please try a different prompt."); } finally { setButtonLoading(aiAlterMapBtn, false); } }
            function populateSelectors() { terrainSelector.innerHTML = ''; Object.keys(terrains).forEach(key => { const itemContainer = document.createElement('div'); itemContainer.className = 'item-container'; itemContainer.dataset.terrain = key; itemContainer.addEventListener('click', () => { currentTool = 'paint'; selectedTerrain = key; updateActiveSwatches(); }); itemContainer.innerHTML = `<div class="texture-swatch" style="background-color: ${terrains[key].color};"></div><div class="item-label">${terrains[key].name}</div>`; terrainSelector.appendChild(itemContainer); }); objectSelector.innerHTML = ''; Object.keys(objectCategories).forEach(mainCatKey => { const mainCat = objectCategories[mainCatKey]; Object.keys(mainCat).forEach(subCatKey => { const subCat = mainCat[subCatKey]; Object.keys(subCat).forEach(objKey => { const item = subCat[objKey]; const fullKey = `${mainCatKey}.${subCatKey}.${objKey}`; const itemContainer = document.createElement('div'); itemContainer.className = 'item-container'; itemContainer.dataset.objectKey = fullKey; itemContainer.addEventListener('click', () => { currentTool = 'place'; selectedObjectKey = fullKey; updateActiveSwatches(); }); itemContainer.innerHTML = `<div class="object-swatch">${item.symbol}</div><div class="item-label">${item.name}</div>`; objectSelector.appendChild(itemContainer); }); }); }); updateActiveSwatches(); }
            function updateActiveSwatches() { document.querySelectorAll('#mapMakerContainer .control-panel.active, #mapMakerContainer button.active, #mapMakerContainer .item-container.active').forEach(el => el.classList.remove('active')); canvas.classList.remove('erasing'); if (textToolPanel) textToolPanel.classList.remove('active'); const toolButtons = { paint: toolPaintBtn, line: toolLineBtn, rectangle: toolRectBtn, ellipse: toolEllipseBtn, eraser: eraserBtn, link: toolLinkBtn }; if(toolButtons[currentTool]) toolButtons[currentTool].classList.add('active'); if (currentTool === 'place') document.querySelector(`.item-container[data-object-key="${selectedObjectKey}"]`)?.classList.add('active'); else if (currentTool === 'text') textToolPanel.classList.add('active'); if(['paint', 'line', 'rectangle', 'ellipse'].includes(currentTool)) document.querySelector(`.item-container[data-terrain="${selectedTerrain}"]`)?.classList.add('active'); }
            function setButtonLoading(button, isLoading) { if(isLoading) { button.disabled = true; button.innerHTML = '<div class="spinner"></div>'; } else { button.disabled = false; button.innerHTML = button.dataset.originalText || ''; } }
            function showLinkModal(hex) { const key = `${hex.q},${hex.r}`; const allComponents = (scenarioProject.components || []).concat(masterCampaignComponents.map(c => ({...c, source: 'Campaign'}))); if (allComponents.length === 0) { showModal("No components available to link. Add components in the Scenario Guide or link a Campaign with components."); return; } const options = allComponents.map(c => `<option value="${c.id}">${c.data.name} (${c.source === 'Campaign' ? 'Campaign' : c.type.replace('_', ' ')})</option>`).join(''); const modalHTML = `<div class="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-white"><h3 class="text-lg font-bold mb-4">Link Component to Hex (${key})</h3><select id="linkComponentSelect" class="w-full p-2 mb-4 bg-gray-700 rounded">${options}</select><div class="flex justify-end gap-4"><button id="modalCancel" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 transition">Cancel</button><button id="modalConfirm" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition">Link</button></div></div></div>`; document.body.insertAdjacentHTML('beforeend', modalHTML); const modal = document.querySelector('.modal-backdrop'); const cancelBtn = document.getElementById('modalCancel'); const confirmBtn = document.getElementById('modalConfirm'); const selectEl = document.getElementById('linkComponentSelect'); const removeModal = () => document.body.removeChild(modal); cancelBtn.onclick = removeModal; confirmBtn.onclick = () => { const componentId = parseInt(selectEl.value); const layer = layers[activeLayerIndex]; if (!layer.data[key]) layer.data[key] = {}; layer.data[key].linkedComponentId = componentId; drawGrid(); removeModal(); }; }
            function showComponentPopup(mouseX, mouseY, componentId) { const existingPopup = document.getElementById('map-popup'); if(existingPopup) existingPopup.remove(); const allComponents = (scenarioProject.components || []).concat(masterCampaignComponents); const component = allComponents.find(c => c.id === componentId); if (!component) return; const popup = document.createElement('div'); popup.id = 'map-popup'; popup.className = 'map-popup'; let content = `<h4>${component.data.name}</h4>`; const details = component.data.description || component.data.summary || component.data.goal || ''; content += `<p>${details.substring(0, 100)}${details.length > 100 ? '...' : ''}</p>`; popup.innerHTML = content; document.getElementById('canvas-container').appendChild(popup); popup.style.left = `${mouseX + 15}px`; popup.style.top = `${mouseY + 15}px`; }
            
            initialize();
        }

    </script>
</body>
</html>
